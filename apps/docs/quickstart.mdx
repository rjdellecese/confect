---
icon: "rocket"
title: "Quickstart"
description: "Install the library and start using it in your project."
---

## Installation

<CodeGroup>

```bash pnpm
pnpm add @rjdellecese/confect
```

```bash npm
npm install @rjdellecese/confect
```

```bash yarn
yarn add @rjdellecese/confect
```

</CodeGroup>

<Info>

`exactOptionalPropertyTypes`

Normally when using the Effect schema library, it's recommended to set `exactOptionalPropertyTypes` in your `tsconfig.json` to `true`. However, this configuration is not supported by `convex-js` at the moment, so to use Confect, you must set it to `false` instead.

To understand the implications of this, see [this explanation](https://effect.website/docs/guides/schema/introduction#the-exactoptionalpropertytypes-option) in the Effect docs.

</Info>

## Usage

### 1. Define your database schema

<Note>
  Not every Effect `Schema` is valid for use in Confect. See
  <a href="schema-restrictions">schema-restrictions</a> for more information
  about what's permitted and what's not.
</Note>

```ts convex/schema.ts expandable
import {
  defineConfectSchema,
  defineConfectTable,
  GenericId,
} from "@rjdellecese/confect/server";
import { Schema } from "effect";

type Tag = {
  readonly name: string;
  readonly tags: readonly Tag[];
};

const Tag = Schema.Struct({
  name: Schema.String,
  tags: Schema.Array(Schema.suspend((): Schema.Schema<Tag> => Tag)),
});

export const confectSchema = defineConfectSchema({
  notes: defineConfectTable(
    Schema.Struct({
      userId: Schema.optional(GenericId("users")),
      text: Schema.String.pipe(Schema.maxLength(100)),
      tag: Schema.optional(Schema.String),
      author: Schema.optional(
        Schema.Struct({
          role: Schema.Literal("admin", "user"),
          name: Schema.String,
        })
      ),
      embedding: Schema.optional(Schema.Array(Schema.Number)),
    })
  )
    .index("by_text", ["text"])
    .index("by_role", ["author.role"])
    .searchIndex("text", {
      searchField: "text",
      filterFields: ["tag"],
    })
    .vectorIndex("embedding", {
      vectorField: "embedding",
      filterFields: ["author.name", "tag"],
      dimensions: 1536,
    }),
  users: defineConfectTable(
    Schema.Struct({
      username: Schema.String,
    })
  ),
  tags: defineConfectTable(Tag),
});

export default confectSchema.convexSchemaDefinition;
```

### 2. Generate your Convex function constructors and types.

```ts convex/confect.ts expandable
import {
  type ConfectDataModelFromConfectSchemaDefinition,
  ConvexActionCtx,
  ConvexMutationCtx,
  ConvexQueryCtx,
  type DataModelFromConfectDataModel,
  type GenericConfectDoc,
  GenericId,
  makeConfectFunctions,
  type TableNamesInConfectDataModel,
} from "@rjdellecese/confect/server";

import { confectSchema } from "./schema";

export const {
  confectQuery,
  confectInternalQuery,
  confectMutation,
  confectInternalMutation,
  confectAction,
  confectInternalAction,
  ConfectDatabaseReader,
  ConfectDatabaseWriter,
} = makeConfectFunctions(confectSchema);

type ConfectSchemaDefinition = typeof confectSchema;

type ConfectDataModel =
  ConfectDataModelFromConfectSchemaDefinition<ConfectSchemaDefinition>;

type TableNames = TableNamesInConfectDataModel<ConfectDataModel>;

export type ConfectDoc<TableName extends TableNames> = GenericConfectDoc<
  ConfectDataModel,
  TableName
>;

export const Id = <TableName extends TableNames>(tableName: TableName) =>
  GenericId<TableName>(tableName);
export type Id<TableName extends TableNames> = GenericId<TableName>;

export type ConfectDatabaseReader = typeof ConfectDatabaseReader.Identifier;
export type ConfectDatabaseWriter = typeof ConfectDatabaseWriter.Identifier;

export {
  ConfectActionRunner,
  ConfectAuth,
  ConfectMutationRunner,
  ConfectQueryRunner,
  ConfectScheduler,
  ConfectStorageActionWriter,
  ConfectStorageReader,
  ConfectStorageWriter,
  ConfectVectorSearch,
} from "@rjdellecese/confect/server";

type DataModel = DataModelFromConfectDataModel<ConfectDataModel>;

export const QueryCtx = ConvexQueryCtx<DataModel>();
export type QueryCtx = typeof QueryCtx.Identifier;
export const MutationCtx = ConvexMutationCtx<DataModel>();
export type MutationCtx = typeof MutationCtx.Identifier;
export const ActionCtx = ConvexActionCtx<DataModel>();
export type ActionCtx = typeof ActionCtx.Identifier;
```

### 3. Write some Convex functions!

```ts convex/functions.ts expandable
import { Effect } from "effect";
import {
  ConfectDatabaseReader,
  ConfectDatabaseWriter,
  confectAction,
  confectMutation,
  confectQuery,
} from "./confect";
import {
  DeleteNoteArgs,
  DeleteNoteResult,
  GetFirstArgs,
  GetFirstResult,
  GetRandomArgs,
  GetRandomResult,
  InsertNoteArgs,
  InsertNoteResult,
  ListNotesArgs,
  ListNotesResult,
} from "./functions.schemas";

export const insertNote = confectMutation({
  args: InsertNoteArgs,
  returns: InsertNoteResult,
  handler: ({ text }) =>
    Effect.gen(function* () {
      const writer = yield* ConfectDatabaseWriter;

      return yield* writer.insert("notes", { text });
    }),
});

export const listNotes = confectQuery({
  args: ListNotesArgs,
  returns: ListNotesResult,
  handler: () =>
    Effect.gen(function* () {
      const reader = yield* ConfectDatabaseReader;

      return yield* reader
        .table("notes")
        .index("by_creation_time", "desc")
        .collect();
    }),
});

export const deleteNote = confectMutation({
  args: DeleteNoteArgs,
  returns: DeleteNoteResult,
  handler: ({ noteId }) =>
    Effect.gen(function* () {
      const writer = yield* ConfectDatabaseWriter;

      yield* writer.delete("notes", noteId);

      return null;
    }),
});

export const getRandom = confectAction({
  args: GetRandomArgs,
  returns: GetRandomResult,
  handler: () => Effect.succeed(Math.random()),
});

export const getFirst = confectQuery({
  args: GetFirstArgs,
  returns: GetFirstResult,
  handler: () =>
    Effect.gen(function* () {
      const reader = yield* ConfectDatabaseReader;

      return yield* reader.table("notes").index("by_creation_time").first();
    }),
});
```

## Example project

The above files are pulled from a real example project. Check it out [here](https://github.com/rjdellecese/confect/tree/main/example).
