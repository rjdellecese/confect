{"version":3,"file":"FunctionImpl.js","names":["Context","String","Array","Layer","Effect","Ref","setNestedProperty"],"sources":["../../../src/server/FunctionImpl.ts"],"sourcesContent":["import { Array, Context, Effect, Layer, Ref, String } from \"effect\";\nimport type * as FunctionSpec from \"../api/FunctionSpec\";\nimport type * as GroupSpec from \"../api/GroupSpec\";\nimport { setNestedProperty } from \"../internal/utils\";\nimport type * as Api from \"./Api\";\nimport * as Registry from \"./Registry\";\nimport * as RegistryItem from \"./RegistryItem\";\n\n// ============================================================================\n// FunctionImpl Service Tag\n// ============================================================================\n\nexport interface FunctionImpl<\n  GroupPath extends string,\n  FunctionName extends string,\n> {\n  readonly groupPath: GroupPath;\n  readonly functionName: FunctionName;\n}\n\nexport const FunctionImpl = <\n  GroupPath extends string,\n  FunctionName extends string,\n>({\n  groupPath,\n  functionName,\n}: {\n  groupPath: GroupPath;\n  functionName: FunctionName;\n}) =>\n  Context.GenericTag<FunctionImpl<GroupPath, FunctionName>>(\n    `@rjdellecese/confect/server/FunctionImpl/${groupPath}/${functionName}`,\n  );\n\n// ============================================================================\n// make - Create Function Implementation Layer\n// ============================================================================\n\nexport const make = <\n  Api_ extends Api.Api.AnyWithProps,\n  const GroupPath extends GroupSpec.Path.All<Api.Api.Groups<Api_>>,\n  const FunctionName extends FunctionSpec.FunctionSpec.Name<\n    GroupSpec.GroupSpec.Functions<\n      GroupSpec.Path.GroupAt<Api.Api.Groups<Api_>, GroupPath>\n    >\n  >,\n>(\n  api: Api_,\n  groupPath: GroupPath,\n  functionName: FunctionName,\n  handler: RegistryItem.Handler.WithName<\n    Api.Api.Schema<Api_>,\n    GroupSpec.GroupSpec.Functions<\n      GroupSpec.Path.GroupAt<Api.Api.Groups<Api_>, GroupPath>\n    >,\n    FunctionName\n  >,\n): Layer.Layer<FunctionImpl<GroupPath, FunctionName>> => {\n  const groupPathParts = String.split(groupPath, \".\");\n  const [firstGroupPathPart, ...restGroupPathParts] = groupPathParts;\n\n  const group_: GroupSpec.GroupSpec.AnyWithProps = Array.reduce(\n    restGroupPathParts,\n    (api as any).spec.groups[firstGroupPathPart as any]!,\n    (currentGroup: any, groupPathPart: any) =>\n      currentGroup.groups[groupPathPart],\n  );\n\n  const function_ = group_.functions[functionName]!;\n\n  return Layer.effect(\n    FunctionImpl<GroupPath, FunctionName>({\n      groupPath,\n      functionName,\n    }),\n    Effect.gen(function* () {\n      const registry = yield* Registry.Registry;\n\n      yield* Ref.update(registry, (registryItems) =>\n        setNestedProperty(\n          registryItems,\n          [...groupPathParts, functionName],\n          RegistryItem.make({\n            function_,\n            handler: handler as RegistryItem.Handler.AnyWithProps,\n          }),\n        ),\n      );\n\n      return {\n        groupPath,\n        functionName,\n      };\n    }),\n  );\n};\n\n// ============================================================================\n// Namespace Types\n// ============================================================================\n\nexport declare namespace FunctionImpl {\n  /**\n   * Get the function implementation service type for a specific group path and function name.\n   */\n  export type ForGroupPathAndFunction<\n    GroupPath extends string,\n    FunctionName extends string,\n  > = FunctionImpl<GroupPath, FunctionName>;\n\n  /**\n   * Get all function implementation services required for a group at a given path.\n   */\n  export type FromGroupAtPath<\n    GroupPath extends string,\n    Group extends GroupSpec.GroupSpec.AnyWithProps,\n  > =\n    GroupSpec.Path.GroupAt<Group, GroupPath> extends infer GroupAtPath extends\n      GroupSpec.GroupSpec.AnyWithProps\n      ? FunctionSpec.FunctionSpec.Name<\n          GroupSpec.GroupSpec.Functions<GroupAtPath>\n        > extends infer FunctionNames extends string\n        ? FunctionNames extends string\n          ? FunctionImpl<GroupPath, FunctionNames>\n          : never\n        : never\n      : never;\n}\n"],"mappings":";;;;;;;;;;;AAoBA,MAAa,gBAGX,EACA,WACA,mBAKAA,eAAQ,WACN,4CAA4C,UAAU,GAAG,eAC1D;AAMH,MAAa,QASX,KACA,WACA,cACA,YAOuD;CACvD,MAAM,iBAAiBC,cAAO,MAAM,WAAW,IAAI;CACnD,MAAM,CAAC,oBAAoB,GAAG,sBAAsB;CASpD,MAAM,YAP2CC,aAAM,OACrD,oBACC,IAAY,KAAK,OAAO,sBACxB,cAAmB,kBAClB,aAAa,OAAO,eACvB,CAEwB,UAAU;AAEnC,QAAOC,aAAM,OACX,aAAsC;EACpC;EACA;EACD,CAAC,EACFC,cAAO,IAAI,aAAa;EACtB,MAAM,WAAW;AAEjB,SAAOC,WAAI,OAAO,WAAW,kBAC3BC,yCACE,eACA,CAAC,GAAG,gBAAgB,aAAa,mCACf;GAChB;GACS;GACV,CAAC,CACH,CACF;AAED,SAAO;GACL;GACA;GACD;GACD,CACH"}