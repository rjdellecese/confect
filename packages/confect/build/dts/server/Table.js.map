{"version":3,"file":"Table.js","names":["SystemFields.extendWithSystemFields"],"sources":["../../../src/server/Table.ts"],"sourcesContent":["import {\n  defineTable,\n  type SystemFields as ConvexSystemFields,\n  type Expand,\n  type GenericTableIndexes,\n  type GenericTableSearchIndexes,\n  type GenericTableVectorIndexes,\n  type IndexTiebreakerField,\n  type SearchIndexConfig,\n  type TableDefinition,\n  type VectorIndexConfig,\n} from \"convex/server\";\nimport type { GenericValidator, Validator } from \"convex/values\";\nimport { Predicate, Schema } from \"effect\";\nimport * as SystemFields from \"../api/SystemFields\";\nimport {\n  compileTableSchema,\n  type TableSchemaToTableValidator,\n} from \"./SchemaToValidator\";\n\nexport const TypeId = \"@rjdellecese/confect/server/Table\";\nexport type TypeId = typeof TypeId;\n\nexport const isTable = (u: unknown): u is Table.Any =>\n  Predicate.hasProperty(u, TypeId);\n\nexport interface Table<\n  TableName extends string,\n  TableSchema extends Schema.Schema.AnyNoContext,\n  TableValidator extends\n    GenericValidator = TableSchemaToTableValidator<TableSchema>,\n  Indexes extends GenericTableIndexes = {},\n  SearchIndexes extends GenericTableSearchIndexes = {},\n  VectorIndexes extends GenericTableVectorIndexes = {},\n> {\n  readonly [TypeId]: TypeId;\n  readonly tableDefinition: TableDefinition<\n    TableValidator,\n    Indexes,\n    SearchIndexes,\n    VectorIndexes\n  >;\n\n  readonly name: TableName;\n\n  readonly Fields: TableSchema;\n  readonly Doc: SystemFields.ExtendWithSystemFields<TableName, TableSchema>;\n\n  readonly indexes: Indexes;\n\n  index<\n    IndexName extends string,\n    FirstFieldPath extends ExtractFieldPaths<TableValidator>,\n    RestFieldPaths extends ExtractFieldPaths<TableValidator>[],\n  >(\n    name: IndexName,\n    fields: [FirstFieldPath, ...RestFieldPaths],\n  ): Table<\n    TableName,\n    TableSchema,\n    TableValidator,\n    Expand<\n      Indexes &\n        Record<\n          IndexName,\n          [FirstFieldPath, ...RestFieldPaths, IndexTiebreakerField]\n        >\n    >,\n    SearchIndexes,\n    VectorIndexes\n  >;\n\n  searchIndex<\n    IndexName extends string,\n    SearchField extends ExtractFieldPaths<TableValidator>,\n    FilterFields extends ExtractFieldPaths<TableValidator> = never,\n  >(\n    name: IndexName,\n    indexConfig: Expand<SearchIndexConfig<SearchField, FilterFields>>,\n  ): Table<\n    TableName,\n    TableSchema,\n    TableValidator,\n    Indexes,\n    Expand<\n      SearchIndexes &\n        Record<\n          IndexName,\n          {\n            searchField: SearchField;\n            filterFields: FilterFields;\n          }\n        >\n    >,\n    VectorIndexes\n  >;\n\n  vectorIndex<\n    IndexName extends string,\n    VectorField extends ExtractFieldPaths<TableValidator>,\n    FilterFields extends ExtractFieldPaths<TableValidator> = never,\n  >(\n    name: IndexName,\n    indexConfig: Expand<VectorIndexConfig<VectorField, FilterFields>>,\n  ): Table<\n    TableName,\n    TableSchema,\n    TableValidator,\n    Indexes,\n    SearchIndexes,\n    Expand<\n      VectorIndexes &\n        Record<\n          IndexName,\n          {\n            vectorField: VectorField;\n            dimensions: number;\n            filterFields: FilterFields;\n          }\n        >\n    >\n  >;\n}\n\nexport declare namespace Table {\n  export interface Any {\n    readonly [TypeId]: TypeId;\n  }\n\n  export type AnyWithProps = Table<\n    any,\n    Schema.Schema.AnyNoContext,\n    GenericValidator,\n    GenericTableIndexes,\n    GenericTableSearchIndexes,\n    GenericTableVectorIndexes\n  >;\n\n  export type Name<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer TableName,\n      infer _TableSchema,\n      infer _TableValidator,\n      infer _Indexes,\n      infer _SearchIndexes,\n      infer _VectorIndexes\n    >\n      ? TableName & string\n      : never;\n\n  export type TableSchema<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer _TableName,\n      infer TableSchema_,\n      infer _TableValidator,\n      infer _Indexes,\n      infer _SearchIndexes,\n      infer _VectorIndexes\n    >\n      ? TableSchema_\n      : never;\n\n  export type TableValidator<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer _TableName,\n      infer _TableSchema,\n      infer TableValidator_,\n      infer _Indexes,\n      infer _SearchIndexes,\n      infer _VectorIndexes\n    >\n      ? TableValidator_\n      : never;\n\n  export type Indexes<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer _TableName,\n      infer _TableSchema,\n      infer _TableValidator,\n      infer Indexes_,\n      infer _SearchIndexes,\n      infer _VectorIndexes\n    >\n      ? Indexes_\n      : never;\n\n  export type SearchIndexes<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer _TableName,\n      infer _TableSchema,\n      infer _TableValidator,\n      infer _Indexes,\n      infer SearchIndexes_,\n      infer _VectorIndexes\n    >\n      ? SearchIndexes_\n      : never;\n\n  export type VectorIndexes<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer _TableName,\n      infer _TableSchema,\n      infer _TableValidator,\n      infer _Indexes,\n      infer _SearchIndexes,\n      infer VectorIndexes_\n    >\n      ? VectorIndexes_\n      : never;\n\n  export type Doc<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer TableName,\n      infer TableSchema_,\n      infer _TableValidator,\n      infer _Indexes,\n      infer _SearchIndexes,\n      infer _VectorIndexes\n    >\n      ? SystemFields.ExtendWithSystemFields<TableName, TableSchema_>\n      : never;\n\n  export type Fields<TableDef extends AnyWithProps> =\n    TableDef extends Table<\n      infer _TableName,\n      infer TableSchema_,\n      infer _TableValidator,\n      infer _Indexes,\n      infer _SearchIndexes,\n      infer _VectorIndexes\n    >\n      ? TableSchema_\n      : never;\n\n  export type WithName<\n    TableDef extends AnyWithProps,\n    Name_ extends string,\n  > = TableDef extends { readonly name: Name_ } ? TableDef : never;\n\n  export type TablesRecord<Tables extends AnyWithProps> = {\n    readonly [TableName_ in Name<Tables>]: WithName<Tables, TableName_>;\n  };\n}\n\nconst Proto = {\n  [TypeId]: TypeId,\n\n  index<\n    IndexName extends string,\n    FirstFieldPath extends string,\n    RestFieldPaths extends string[],\n  >(\n    this: Table.AnyWithProps,\n    name: IndexName,\n    fields: [FirstFieldPath, ...RestFieldPaths],\n  ) {\n    return makeProto({\n      name: this.name,\n      Fields: this.Fields,\n      Doc: this.Doc,\n      tableDefinition: this.tableDefinition.index(name, fields as any),\n      indexes: {\n        ...this.indexes,\n        [name]: fields,\n      },\n    });\n  },\n\n  searchIndex<IndexName extends string, SearchField extends string>(\n    this: Table.AnyWithProps,\n    name: IndexName,\n    indexConfig: SearchIndexConfig<SearchField, any>,\n  ) {\n    return makeProto({\n      name: this.name,\n      Fields: this.Fields,\n      Doc: this.Doc,\n      tableDefinition: this.tableDefinition.searchIndex(name, indexConfig),\n      indexes: this.indexes,\n    });\n  },\n\n  vectorIndex<IndexName extends string, VectorField extends string>(\n    this: Table.AnyWithProps,\n    name: IndexName,\n    indexConfig: {\n      vectorField: VectorField;\n      dimensions: number;\n      filterFields?: string[] | undefined;\n    },\n  ) {\n    return makeProto({\n      name: this.name,\n      Fields: this.Fields,\n      Doc: this.Doc,\n      tableDefinition: this.tableDefinition.vectorIndex(name, {\n        vectorField: indexConfig.vectorField,\n        dimensions: indexConfig.dimensions,\n        ...(indexConfig.filterFields\n          ? { filterFields: indexConfig.filterFields }\n          : {}),\n      }),\n      indexes: this.indexes,\n    });\n  },\n};\n\nconst makeProto = <\n  TableName extends string,\n  TableSchema extends Schema.Schema.AnyNoContext,\n  TableValidator extends Validator<any, any, any>,\n  Indexes extends GenericTableIndexes,\n  SearchIndexes extends GenericTableSearchIndexes,\n  VectorIndexes extends GenericTableVectorIndexes,\n>({\n  name,\n  Fields,\n  Doc,\n  tableDefinition,\n  indexes,\n}: {\n  name: TableName;\n  Fields: TableSchema;\n  Doc: SystemFields.ExtendWithSystemFields<TableName, TableSchema>;\n  tableDefinition: TableDefinition<\n    TableValidator,\n    Indexes,\n    SearchIndexes,\n    VectorIndexes\n  >;\n  indexes: Indexes;\n}): Table<\n  TableName,\n  TableSchema,\n  TableValidator,\n  Indexes,\n  SearchIndexes,\n  VectorIndexes\n> =>\n  Object.assign(Object.create(Proto), {\n    name,\n    Fields,\n    Doc,\n    tableDefinition,\n    indexes,\n  });\n\n/**\n * Create a table.\n */\nexport const make = <\n  const TableName extends string,\n  TableSchema extends Schema.Schema.AnyNoContext,\n>(\n  name: TableName,\n  fields: TableSchema,\n): Table<TableName, TableSchema> => {\n  const tableValidator = compileTableSchema(fields);\n  const tableDefinition = defineTable(tableValidator);\n\n  return makeProto({\n    name,\n    Fields: fields,\n    Doc: SystemFields.extendWithSystemFields(name, fields),\n    tableDefinition,\n    indexes: {},\n  });\n};\n\n// -----------------------------------------------------------------------------\n// System tables\n// -----------------------------------------------------------------------------\n\nexport const scheduledFunctionsTable = make(\n  \"_scheduled_functions\",\n  Schema.Struct({\n    name: Schema.String,\n    args: Schema.Array(Schema.Any),\n    scheduledTime: Schema.Number,\n    completedTime: Schema.optionalWith(Schema.Number, { exact: true }),\n    state: Schema.Union(\n      Schema.Struct({ kind: Schema.Literal(\"pending\") }),\n      Schema.Struct({ kind: Schema.Literal(\"inProgress\") }),\n      Schema.Struct({ kind: Schema.Literal(\"success\") }),\n      Schema.Struct({\n        kind: Schema.Literal(\"failed\"),\n        error: Schema.String,\n      }),\n      Schema.Struct({ kind: Schema.Literal(\"canceled\") }),\n    ),\n  }),\n);\n\nexport const storageTable = make(\n  \"_storage\",\n  Schema.Struct({\n    sha256: Schema.String,\n    size: Schema.Number,\n    contentType: Schema.optionalWith(Schema.String, { exact: true }),\n  }),\n);\n\nexport const systemTables = {\n  _scheduled_functions: scheduledFunctionsTable,\n  _storage: storageTable,\n} as const;\n\nexport type SystemTables = typeof scheduledFunctionsTable | typeof storageTable;\n\n// Vendored types from convex-js, partially modified. Ideally we could use these directly. See https://github.com/get-convex/convex-js/pull/14\n\n/**\n * Extract all of the index field paths within a {@link Validator}.\n *\n * This is used within {@link defineTable}.\n * @public\n */\ntype ExtractFieldPaths<T extends Validator<any, any, any>> =\n  // Add in the system fields available in index definitions.\n  // This should be everything except for `_id` because thats added to indexes\n  // automatically.\n  T[\"fieldPaths\"] | keyof ConvexSystemFields;\n"],"mappings":";;;;;;;;;;;;;;;AAoBA,MAAa,SAAS;AAGtB,MAAa,WAAW,MACtB,UAAU,YAAY,GAAG,OAAO;AA4NlC,MAAM,QAAQ;EACX,SAAS;CAEV,MAME,MACA,QACA;AACA,SAAO,UAAU;GACf,MAAM,KAAK;GACX,QAAQ,KAAK;GACb,KAAK,KAAK;GACV,iBAAiB,KAAK,gBAAgB,MAAM,MAAM,OAAc;GAChE,SAAS;IACP,GAAG,KAAK;KACP,OAAO;IACT;GACF,CAAC;;CAGJ,YAEE,MACA,aACA;AACA,SAAO,UAAU;GACf,MAAM,KAAK;GACX,QAAQ,KAAK;GACb,KAAK,KAAK;GACV,iBAAiB,KAAK,gBAAgB,YAAY,MAAM,YAAY;GACpE,SAAS,KAAK;GACf,CAAC;;CAGJ,YAEE,MACA,aAKA;AACA,SAAO,UAAU;GACf,MAAM,KAAK;GACX,QAAQ,KAAK;GACb,KAAK,KAAK;GACV,iBAAiB,KAAK,gBAAgB,YAAY,MAAM;IACtD,aAAa,YAAY;IACzB,YAAY,YAAY;IACxB,GAAI,YAAY,eACZ,EAAE,cAAc,YAAY,cAAc,GAC1C,EAAE;IACP,CAAC;GACF,SAAS,KAAK;GACf,CAAC;;CAEL;AAED,MAAM,aAOJ,EACA,MACA,QACA,KACA,iBACA,cAoBA,OAAO,OAAO,OAAO,OAAO,MAAM,EAAE;CAClC;CACA;CACA;CACA;CACA;CACD,CAAC;;;;AAKJ,MAAa,QAIX,MACA,WACkC;CAElC,MAAM,kBAAkB,YADD,mBAAmB,OAAO,CACE;AAEnD,QAAO,UAAU;EACf;EACA,QAAQ;EACR,KAAKA,uBAAoC,MAAM,OAAO;EACtD;EACA,SAAS,EAAE;EACZ,CAAC;;AAOJ,MAAa,0BAA0B,KACrC,wBACA,OAAO,OAAO;CACZ,MAAM,OAAO;CACb,MAAM,OAAO,MAAM,OAAO,IAAI;CAC9B,eAAe,OAAO;CACtB,eAAe,OAAO,aAAa,OAAO,QAAQ,EAAE,OAAO,MAAM,CAAC;CAClE,OAAO,OAAO,MACZ,OAAO,OAAO,EAAE,MAAM,OAAO,QAAQ,UAAU,EAAE,CAAC,EAClD,OAAO,OAAO,EAAE,MAAM,OAAO,QAAQ,aAAa,EAAE,CAAC,EACrD,OAAO,OAAO,EAAE,MAAM,OAAO,QAAQ,UAAU,EAAE,CAAC,EAClD,OAAO,OAAO;EACZ,MAAM,OAAO,QAAQ,SAAS;EAC9B,OAAO,OAAO;EACf,CAAC,EACF,OAAO,OAAO,EAAE,MAAM,OAAO,QAAQ,WAAW,EAAE,CAAC,CACpD;CACF,CAAC,CACH;AAED,MAAa,eAAe,KAC1B,YACA,OAAO,OAAO;CACZ,QAAQ,OAAO;CACf,MAAM,OAAO;CACb,aAAa,OAAO,aAAa,OAAO,QAAQ,EAAE,OAAO,MAAM,CAAC;CACjE,CAAC,CACH;AAED,MAAa,eAAe;CAC1B,sBAAsB;CACtB,UAAU;CACX"}