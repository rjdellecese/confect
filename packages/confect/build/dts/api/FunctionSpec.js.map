{"version":3,"file":"FunctionSpec.js","names":[],"sources":["../../../src/api/FunctionSpec.ts"],"sourcesContent":["import type { Schema } from \"effect\";\nimport { Predicate } from \"effect\";\nimport { validateJsIdentifier } from \"../internal/utils\";\nimport type {\n  RegisteredAction,\n  RegisteredMutation,\n  RegisteredQuery,\n} from \"convex/server\";\n\nexport const TypeId = \"@rjdellecese/confect/api/FunctionSpec\";\nexport type TypeId = typeof TypeId;\n\nexport const isFunctionSpec = (u: unknown): u is FunctionSpec.AnyWithProps =>\n  Predicate.hasProperty(u, TypeId);\n\nexport interface FunctionSpec<\n  FunctionType extends FunctionSpec.FunctionType,\n  FunctionVisibility extends FunctionSpec.FunctionVisibility,\n  Name extends string,\n  Args extends Schema.Schema.AnyNoContext,\n  Returns extends Schema.Schema.AnyNoContext,\n> {\n  readonly [TypeId]: TypeId;\n  readonly functionType: FunctionType;\n  readonly functionVisibility: FunctionVisibility;\n  readonly name: Name;\n  readonly args: Args;\n  readonly returns: Returns;\n}\n\nexport declare namespace FunctionSpec {\n  export interface Any {\n    readonly [TypeId]: TypeId;\n  }\n\n  export interface AnyWithProps\n    extends FunctionSpec<\n      FunctionType,\n      FunctionVisibility,\n      string,\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  interface AnyWithPropsWithFunctionType<FunctionType_ extends FunctionType>\n    extends FunctionSpec<\n      FunctionType_,\n      FunctionVisibility,\n      string,\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  // TODO: Use type from convex-js?\n  export type FunctionType = \"Query\" | \"Mutation\" | \"Action\";\n\n  export type GetFunctionType<Function extends AnyWithProps> =\n    Function[\"functionType\"];\n\n  // TODO: Use type from convex-js?\n  export type FunctionVisibility = \"Public\" | \"Internal\";\n\n  export type GetFunctionVisibility<Function extends AnyWithProps> =\n    Function[\"functionVisibility\"];\n\n  export type Name<Function extends AnyWithProps> = Function[\"name\"];\n\n  export type Args<Function extends AnyWithProps> = Function[\"args\"];\n\n  export type Returns<Function extends AnyWithProps> = Function[\"returns\"];\n\n  export type WithName<\n    Function extends AnyWithProps,\n    Name_ extends string,\n  > = Extract<Function, { readonly name: Name_ }>;\n\n  export type WithFunctionType<\n    Function extends AnyWithProps,\n    FunctionType_ extends FunctionType,\n  > = Extract<Function, { readonly functionType: FunctionType_ }>;\n\n  export type ExcludeName<\n    Function extends AnyWithProps,\n    Name_ extends Name<Function>,\n  > = Exclude<Function, { readonly name: Name_ }>;\n\n  export type RegisteredFunction<Function extends FunctionSpec.AnyWithProps> =\n    Function[\"functionType\"] extends \"Query\"\n      ? RegisteredQuery<\n          Lowercase<GetFunctionVisibility<Function>>,\n          Args<Function>[\"Encoded\"],\n          Promise<Returns<Function>[\"Encoded\"]>\n        >\n      : Function[\"functionType\"] extends \"Mutation\"\n        ? RegisteredMutation<\n            Lowercase<GetFunctionVisibility<Function>>,\n            Args<Function>[\"Encoded\"],\n            Promise<Returns<Function>[\"Encoded\"]>\n          >\n        : Function[\"functionType\"] extends \"Action\"\n          ? RegisteredAction<\n              Lowercase<GetFunctionVisibility<Function>>,\n              Args<Function>[\"Encoded\"],\n              Promise<Returns<Function>[\"Encoded\"]>\n            >\n          : never;\n}\n\nconst Proto = {\n  [TypeId]: TypeId,\n};\n\nconst make =\n  <\n    FunctionType extends FunctionSpec.FunctionType,\n    FunctionVisibility extends FunctionSpec.FunctionVisibility,\n  >(\n    functionType: FunctionType,\n    functionVisibility: FunctionVisibility,\n  ) =>\n  <\n    const Name extends string,\n    Args extends Schema.Schema.AnyNoContext,\n    Returns extends Schema.Schema.AnyNoContext,\n  >({\n    name,\n    args,\n    returns,\n  }: {\n    name: Name;\n    args: Args;\n    returns: Returns;\n  }): FunctionSpec<FunctionType, FunctionVisibility, Name, Args, Returns> => {\n    validateJsIdentifier(name);\n\n    return Object.assign(Object.create(Proto), {\n      functionType,\n      functionVisibility,\n      name,\n      args,\n      returns,\n    });\n  };\n\nexport const internalQuery = make(\"Query\", \"Internal\");\nexport const query = make(\"Query\", \"Public\");\n\nexport const internalMutation = make(\"Mutation\", \"Internal\");\nexport const mutation = make(\"Mutation\", \"Public\");\n\nexport const internalAction = make(\"Action\", \"Internal\");\nexport const action = make(\"Action\", \"Public\");\n"],"mappings":";;;;;;;;;;;;;;;AASA,MAAa,SAAS;AAGtB,MAAa,kBAAkB,MAC7B,UAAU,YAAY,GAAG,OAAO;AA+FlC,MAAM,QAAQ,GACX,SAAS,QACX;AAED,MAAM,QAKF,cACA,wBAMA,EACA,MACA,MACA,cAKyE;AACzE,sBAAqB,KAAK;AAE1B,QAAO,OAAO,OAAO,OAAO,OAAO,MAAM,EAAE;EACzC;EACA;EACA;EACA;EACA;EACD,CAAC;;AAGN,MAAa,gBAAgB,KAAK,SAAS,WAAW;AACtD,MAAa,QAAQ,KAAK,SAAS,SAAS;AAE5C,MAAa,mBAAmB,KAAK,YAAY,WAAW;AAC5D,MAAa,WAAW,KAAK,YAAY,SAAS;AAElD,MAAa,iBAAiB,KAAK,UAAU,WAAW;AACxD,MAAa,SAAS,KAAK,UAAU,SAAS"}