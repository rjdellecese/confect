{"version":3,"file":"DatabaseSchema.js","names":["defineConvexSchema","Table.scheduledFunctionsTable","Table.storageTable","Table.systemTables"],"sources":["../../../src/server/DatabaseSchema.ts"],"sourcesContent":["import type { GenericSchema } from \"convex/server\";\nimport {\n  defineSchema as defineConvexSchema,\n  type SchemaDefinition,\n} from \"convex/server\";\nimport { Array, pipe, Predicate, Record } from \"effect\";\nimport * as Table from \"./Table\";\n\nexport const TypeId = \"@rjdellecese/confect/server/Schema\";\nexport type TypeId = typeof TypeId;\n\nexport const isSchema = (u: unknown): u is DatabaseSchema.Any =>\n  Predicate.hasProperty(u, TypeId);\n\n/**\n * A schema definition tracks the schema and its Convex schema definition.\n */\nexport interface DatabaseSchema<\n  Tables extends Table.Table.AnyWithProps = never,\n> {\n  readonly [TypeId]: TypeId;\n  readonly tables: Table.Table.TablesRecord<Tables>;\n  readonly convexSchemaDefinition: SchemaDefinition<GenericSchema, true>;\n\n  /**\n   * Add a table definition to the schema.\n   */\n  addTable<TableDef extends Table.Table.AnyWithProps>(\n    table: TableDef,\n  ): DatabaseSchema<Tables | TableDef>;\n}\n\nexport declare namespace DatabaseSchema {\n  export interface Any {\n    readonly [TypeId]: TypeId;\n  }\n\n  export interface AnyWithProps {\n    readonly [TypeId]: TypeId;\n    readonly tables: Record<string, Table.Table.AnyWithProps>;\n    readonly convexSchemaDefinition: SchemaDefinition<GenericSchema, true>;\n    addTable<TableDef extends Table.Table.AnyWithProps>(\n      table: TableDef,\n    ): AnyWithProps;\n  }\n\n  export type Tables<S extends AnyWithProps> =\n    S extends DatabaseSchema<infer Tables_> ? Tables_ : never;\n\n  export type TableNames<S extends AnyWithProps> = Table.Table.Name<Tables<S>> &\n    string;\n\n  export type TableWithName<\n    S extends AnyWithProps,\n    TableName extends TableNames<S>,\n  > = Extract<Tables<S>, { readonly name: TableName }>;\n}\n\nconst Proto = {\n  [TypeId]: TypeId,\n\n  addTable<TableDef extends Table.Table.AnyWithProps>(\n    this: DatabaseSchema<Table.Table.AnyWithProps>,\n    table: TableDef,\n  ) {\n    const tablesArray = Object.values(\n      this.tables,\n    ) as Table.Table.AnyWithProps[];\n    const newTablesArray = [...tablesArray, table];\n\n    return makeProto({\n      tables: Record.set(this.tables, table.name, table),\n      convexSchemaDefinition: pipe(\n        newTablesArray,\n        Array.map(\n          ({ name, tableDefinition }) => [name, tableDefinition] as const,\n        ),\n        Record.fromEntries,\n        defineConvexSchema,\n      ),\n    });\n  },\n};\n\nconst makeProto = <Tables extends Table.Table.AnyWithProps>({\n  tables,\n  convexSchemaDefinition,\n}: {\n  tables: Record.ReadonlyRecord<string, Tables>;\n  convexSchemaDefinition: SchemaDefinition<GenericSchema, true>;\n}): DatabaseSchema<Tables> =>\n  Object.assign(Object.create(Proto), {\n    tables,\n    convexSchemaDefinition,\n  });\n\n/**\n * Create an empty schema definition. Add tables incrementally via `addTable`.\n */\nexport const make = (): DatabaseSchema<never> =>\n  makeProto({\n    tables: Record.empty(),\n    convexSchemaDefinition: defineConvexSchema({}),\n  });\n\n// System tables\n\nexport const systemSchema = make()\n  .addTable(Table.scheduledFunctionsTable)\n  .addTable(Table.storageTable);\n\nexport const extendWithSystemTables = <Tables extends Table.Table.AnyWithProps>(\n  tables: Table.Table.TablesRecord<Tables>,\n): ExtendWithSystemTables<Tables> =>\n  ({\n    ...tables,\n    ...Table.systemTables,\n  }) as ExtendWithSystemTables<Tables>;\n\nexport type ExtendWithSystemTables<Tables extends Table.Table.AnyWithProps> =\n  Table.Table.TablesRecord<Tables | Table.SystemTables>;\n\nexport type IncludeSystemTables<Tables extends Table.Table.AnyWithProps> =\n  | Tables\n  | Table.SystemTables;\n"],"mappings":";;;;;;;;;;;;;AAQA,MAAa,SAAS;AAGtB,MAAa,YAAY,MACvB,UAAU,YAAY,GAAG,OAAO;AA8ClC,MAAM,QAAQ;EACX,SAAS;CAEV,SAEE,OACA;EAIA,MAAM,iBAAiB,CAAC,GAHJ,OAAO,OACzB,KAAK,OACN,EACuC,MAAM;AAE9C,SAAO,UAAU;GACf,QAAQ,OAAO,IAAI,KAAK,QAAQ,MAAM,MAAM,MAAM;GAClD,wBAAwB,KACtB,gBACA,MAAM,KACH,EAAE,MAAM,sBAAsB,CAAC,MAAM,gBAAgB,CACvD,EACD,OAAO,aACPA,aACD;GACF,CAAC;;CAEL;AAED,MAAM,aAAsD,EAC1D,QACA,6BAKA,OAAO,OAAO,OAAO,OAAO,MAAM,EAAE;CAClC;CACA;CACD,CAAC;;;;AAKJ,MAAa,aACX,UAAU;CACR,QAAQ,OAAO,OAAO;CACtB,wBAAwBA,aAAmB,EAAE,CAAC;CAC/C,CAAC;AAIJ,MAAa,eAAe,MAAM,CAC/B,SAASC,wBAA8B,CACvC,SAASC,aAAmB;AAE/B,MAAa,0BACX,YAEC;CACC,GAAG;CACH,GAAGC;CACJ"}