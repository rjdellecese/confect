{"version":3,"file":"DatabaseReader.js","names":["DatabaseSchema.extendWithSystemTables","baseDatabaseReader: BaseDatabaseReader<any>","Table.systemTables","QueryInitializer.make"],"sources":["../../../src/server/DatabaseReader.ts"],"sourcesContent":["import type { GenericDatabaseReader } from \"convex/server\";\nimport { Array, Context, Layer } from \"effect\";\nimport type { BaseDatabaseReader } from \"../internal/typeUtils\";\nimport type * as DataModel from \"./DataModel\";\nimport * as QueryInitializer from \"./QueryInitializer\";\nimport * as DatabaseSchema from \"./DatabaseSchema\";\nimport * as Table from \"./Table\";\n\nexport const make = <Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps>(\n  schema: Schema,\n  convexDatabaseReader: GenericDatabaseReader<\n    DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n  >,\n) => {\n  type Tables = DatabaseSchema.DatabaseSchema.Tables<Schema>;\n  type IncludedTables = DatabaseSchema.IncludeSystemTables<Tables>;\n  const extendedTables = DatabaseSchema.extendWithSystemTables(\n    schema.tables as Table.Table.TablesRecord<Tables>,\n  );\n\n  return {\n    table: <const TableName extends Table.Table.Name<IncludedTables>>(\n      tableName: TableName,\n    ) => {\n      const table = Object.values(extendedTables).find(\n        (def) => def.name === tableName,\n      ) as Table.Table.WithName<IncludedTables, TableName>;\n\n      const baseDatabaseReader: BaseDatabaseReader<any> = Array.some(\n        Object.values(Table.systemTables),\n        (systemTableDef) => systemTableDef.name === tableName,\n      )\n        ? ({\n            get: convexDatabaseReader.system.get,\n            query: convexDatabaseReader.system.query,\n          } as BaseDatabaseReader<\n            DataModel.DataModel.ToConvex<\n              DataModel.DataModel.FromTables<Table.SystemTables>\n            >\n          >)\n        : ({\n            get: convexDatabaseReader.get,\n            query: convexDatabaseReader.query,\n          } as BaseDatabaseReader<\n            DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n          >);\n\n      return QueryInitializer.make<IncludedTables, TableName>(\n        tableName,\n        baseDatabaseReader,\n        table,\n      );\n    },\n  };\n};\n\nexport const DatabaseReader = <Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps>() =>\n  Context.GenericTag<ReturnType<typeof make<Schema>>>(\n    \"@rjdellecese/confect/server/DatabaseReader\",\n  );\n\nexport type DatabaseReader<Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps> =\n  ReturnType<typeof DatabaseReader<Schema>>[\"Identifier\"];\n\nexport const layer = <Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps>(\n  schema: Schema,\n  convexDatabaseReader: GenericDatabaseReader<\n    DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n  >,\n) =>\n  Layer.succeed(DatabaseReader<Schema>(), make(schema, convexDatabaseReader));\n"],"mappings":";;;;;;;;;;;;AAQA,MAAa,QACX,QACA,yBAGG;CAGH,MAAM,iBAAiBA,uBACrB,OAAO,OACR;AAED,QAAO,EACL,QACE,cACG;EACH,MAAM,QAAQ,OAAO,OAAO,eAAe,CAAC,MACzC,QAAQ,IAAI,SAAS,UACvB;EAED,MAAMC,qBAA8C,MAAM,KACxD,OAAO,OAAOC,aAAmB,GAChC,mBAAmB,eAAe,SAAS,UAC7C,GACI;GACC,KAAK,qBAAqB,OAAO;GACjC,OAAO,qBAAqB,OAAO;GACpC,GAKA;GACC,KAAK,qBAAqB;GAC1B,OAAO,qBAAqB;GAC7B;AAIL,SAAOC,OACL,WACA,oBACA,MACD;IAEJ;;AAGH,MAAa,uBACX,QAAQ,WACN,6CACD;AAKH,MAAa,SACX,QACA,yBAIA,MAAM,QAAQ,gBAAwB,EAAE,KAAK,QAAQ,qBAAqB,CAAC"}