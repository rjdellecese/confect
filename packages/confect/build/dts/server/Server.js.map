{"version":3,"file":"Server.js","names":["Registry.Registry","RegistryItem.isRegistryItem","SchemaToValidator.compileArgsSchema","SchemaToValidator.compileReturnsSchema","DatabaseReader.layer","Auth.layer","StorageReader","QueryRunner.layer","QueryCtx.QueryCtx","DatabaseWriter.layer","Scheduler.layer","StorageWriter","MutationRunner.layer","MutationCtx.MutationCtx","StorageActionWriter","ActionRunner.layer","VectorSearch.layer","ActionCtx.ActionCtx"],"sources":["../../../src/server/Server.ts"],"sourcesContent":["import {\n  actionGeneric,\n  type DefaultFunctionArgs,\n  type FunctionVisibility,\n  type GenericActionCtx,\n  type GenericMutationCtx,\n  type GenericQueryCtx,\n  internalActionGeneric,\n  internalMutationGeneric,\n  internalQueryGeneric,\n  mutationGeneric,\n  queryGeneric,\n  type RegisteredAction,\n  type RegisteredMutation,\n  type RegisteredQuery,\n} from \"convex/server\";\nimport {\n  Effect,\n  Layer,\n  Match,\n  pipe,\n  Predicate,\n  Ref,\n  Schema,\n  type Types,\n} from \"effect\";\nimport type * as FunctionSpec from \"../api/FunctionSpec\";\nimport type * as GroupSpec from \"../api/GroupSpec\";\nimport type * as Spec from \"../api/Spec\";\nimport { mapLeaves } from \"../internal/utils\";\nimport * as ActionCtx from \"./ActionCtx\";\nimport * as ActionRunner from \"./ActionRunner\";\nimport type * as Api from \"./Api\";\nimport * as Auth from \"./Auth\";\nimport * as DatabaseReader from \"./DatabaseReader\";\nimport * as DatabaseWriter from \"./DatabaseWriter\";\nimport type * as DataModel from \"./DataModel\";\nimport * as MutationCtx from \"./MutationCtx\";\nimport * as MutationRunner from \"./MutationRunner\";\nimport * as QueryCtx from \"./QueryCtx\";\nimport * as QueryRunner from \"./QueryRunner\";\nimport * as Registry from \"./Registry\";\nimport * as RegistryItem from \"./RegistryItem\";\nimport * as Scheduler from \"./Scheduler\";\nimport type * as DatabaseSchema from \"./DatabaseSchema\";\nimport * as SchemaToValidator from \"./SchemaToValidator\";\nimport { StorageActionWriter, StorageReader, StorageWriter } from \"./Storage\";\nimport * as VectorSearch from \"./VectorSearch\";\n\nexport type RegisteredFunction =\n  | RegisteredQuery<FunctionVisibility, DefaultFunctionArgs, any>\n  | RegisteredMutation<FunctionVisibility, DefaultFunctionArgs, any>\n  | RegisteredAction<FunctionVisibility, DefaultFunctionArgs, any>;\n\nconst isRegisteredQuery = (\n  u: unknown,\n): u is RegisteredQuery<FunctionVisibility, DefaultFunctionArgs, any> =>\n  Predicate.hasProperty(u, \"isQuery\") && u.isQuery === true;\n\nconst isRegisteredMutation = (\n  u: unknown,\n): u is RegisteredMutation<FunctionVisibility, DefaultFunctionArgs, any> =>\n  Predicate.hasProperty(u, \"isMutation\") && u.isMutation === true;\n\nconst isRegisteredAction = (\n  u: unknown,\n): u is RegisteredAction<FunctionVisibility, DefaultFunctionArgs, any> =>\n  Predicate.hasProperty(u, \"isAction\") && u.isAction === true;\n\nexport const isRegisteredFunction = (u: unknown): u is RegisteredFunction =>\n  isRegisteredQuery(u) || isRegisteredMutation(u) || isRegisteredAction(u);\n\nexport const TypeId = \"@rjdellecese/confect/server/Server\";\nexport type TypeId = typeof TypeId;\n\nexport const isServer = (u: unknown): u is Server<Api.Api.AnyWithProps> =>\n  Predicate.hasProperty(u, TypeId);\n\nexport type RegisteredFunctions<Spec_ extends Spec.Spec.AnyWithProps> =\n  Types.Simplify<RegisteredFunctions.Helper<Spec.Spec.Groups<Spec_>>>;\n\nexport interface Server<Api_ extends Api.Api.AnyWithProps> {\n  readonly [TypeId]: TypeId;\n  readonly registeredFunctions: RegisteredFunctions<Api_[\"spec\"]>;\n}\n\nconst Proto = {\n  [TypeId]: TypeId,\n};\n\nconst makeProto = <Api_ extends Api.Api.AnyWithProps>({\n  registeredFunctions,\n}: {\n  registeredFunctions: RegisteredFunctions<Api_[\"spec\"]>;\n}): Server<Api_> =>\n  Object.assign(Object.create(Proto), {\n    registeredFunctions,\n  });\n\nexport const make = <Api_ extends Api.Api.AnyWithProps>(api: Api_) =>\n  Effect.gen(function* () {\n    const registry = yield* Registry.Registry;\n    const functionImplItems = yield* Ref.get(registry);\n\n    const registeredFunctions = mapLeaves<\n      RegistryItem.RegistryItem.AnyWithProps,\n      RegisteredFunction\n    >(functionImplItems, RegistryItem.isRegistryItem, (registryItem) =>\n      makeRegisteredFunction(api, registryItem),\n    ) as RegisteredFunctions<Api_[\"spec\"]>;\n\n    return makeProto<Api_>({ registeredFunctions });\n  });\n\nconst makeRegisteredFunction = <Api_ extends Api.Api.AnyWithProps>(\n  api: Api_,\n  { function_, handler }: RegistryItem.RegistryItem.AnyWithProps,\n): RegisteredFunction =>\n  Match.value(function_.functionType).pipe(\n    Match.when(\"Query\", () => {\n      const genericFunction = Match.value(function_.functionVisibility).pipe(\n        Match.when(\"Public\", () => queryGeneric),\n        Match.when(\"Internal\", () => internalQueryGeneric),\n        Match.exhaustive,\n      );\n\n      return genericFunction(\n        queryFunction(api.schema, {\n          args: function_.args,\n          returns: function_.returns,\n          handler,\n        }),\n      );\n    }),\n    Match.when(\"Mutation\", () => {\n      const genericFunction = Match.value(function_.functionVisibility).pipe(\n        Match.when(\"Public\", () => mutationGeneric),\n        Match.when(\"Internal\", () => internalMutationGeneric),\n        Match.exhaustive,\n      );\n\n      return genericFunction(\n        mutationFunction(api.schema, {\n          args: function_.args,\n          returns: function_.returns,\n          handler,\n        }),\n      );\n    }),\n    Match.when(\"Action\", () => {\n      const genericFunction = Match.value(function_.functionVisibility).pipe(\n        Match.when(\"Public\", () => actionGeneric),\n        Match.when(\"Internal\", () => internalActionGeneric),\n        Match.exhaustive,\n      );\n\n      return genericFunction(\n        actionFunction({\n          args: function_.args,\n          returns: function_.returns,\n          handler,\n        }),\n      );\n    }),\n    Match.exhaustive,\n  );\n\nconst queryFunction = <\n  Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps,\n  ConvexArgs extends DefaultFunctionArgs,\n  Args,\n  ConvexReturns,\n  Returns,\n  E,\n>(\n  schema: Schema,\n  {\n    args,\n    returns,\n    handler,\n  }: {\n    args: Schema.Schema<Args, ConvexArgs>;\n    returns: Schema.Schema<Returns, ConvexReturns>;\n    handler: (\n      a: Args,\n    ) => Effect.Effect<\n      Returns,\n      E,\n      | DatabaseReader.DatabaseReader<Schema>\n      | Auth.Auth\n      | StorageReader\n      | QueryRunner.QueryRunner\n      | QueryCtx.QueryCtx<\n          DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n        >\n    >;\n  },\n) => ({\n  args: SchemaToValidator.compileArgsSchema(args),\n  returns: SchemaToValidator.compileReturnsSchema(returns),\n  handler: (\n    ctx: GenericQueryCtx<\n      DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n    >,\n    actualArgs: ConvexArgs,\n  ): Promise<ConvexReturns> =>\n    pipe(\n      actualArgs,\n      Schema.decode(args),\n      Effect.orDie,\n      Effect.andThen((decodedArgs) =>\n        pipe(\n          handler(decodedArgs),\n          Effect.provide(\n            Layer.mergeAll(\n              DatabaseReader.layer(schema, ctx.db),\n              Auth.layer(ctx.auth),\n              StorageReader.layer(ctx.storage),\n              QueryRunner.layer(ctx.runQuery),\n              Layer.succeed(\n                QueryCtx.QueryCtx<\n                  DataModel.DataModel.ToConvex<\n                    DataModel.DataModel.FromSchema<Schema>\n                  >\n                >(),\n                ctx,\n              ),\n            ),\n          ),\n        ),\n      ),\n      Effect.andThen((convexReturns) =>\n        Schema.encodeUnknown(returns)(convexReturns),\n      ),\n      Effect.runPromise,\n    ),\n});\n\nconst mutationFunction = <\n  Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps,\n  ConvexArgs extends DefaultFunctionArgs,\n  Args,\n  ConvexReturns,\n  Returns,\n  E,\n>(\n  schema: Schema,\n  {\n    args,\n    returns,\n    handler,\n  }: {\n    args: Schema.Schema<Args, ConvexArgs>;\n    returns: Schema.Schema<Returns, ConvexReturns>;\n    handler: (\n      a: Args,\n    ) => Effect.Effect<\n      Returns,\n      E,\n      | DatabaseReader.DatabaseReader<Schema>\n      | DatabaseWriter.DatabaseWriter<Schema>\n      | Auth.Auth\n      | Scheduler.Scheduler\n      | StorageReader\n      | StorageWriter\n      | QueryRunner.QueryRunner\n      | MutationRunner.MutationRunner\n      | MutationCtx.MutationCtx<\n          DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n        >\n    >;\n  },\n) => ({\n  args: SchemaToValidator.compileArgsSchema(args),\n  returns: SchemaToValidator.compileReturnsSchema(returns),\n  handler: (\n    ctx: GenericMutationCtx<\n      DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n    >,\n    actualArgs: ConvexArgs,\n  ): Promise<ConvexReturns> =>\n    pipe(\n      actualArgs,\n      Schema.decode(args),\n      Effect.orDie,\n      Effect.andThen((decodedArgs) =>\n        pipe(\n          handler(decodedArgs),\n          Effect.provide(\n            Layer.mergeAll(\n              DatabaseReader.layer(schema, ctx.db),\n              DatabaseWriter.layer(schema, ctx.db),\n              Auth.layer(ctx.auth),\n              Scheduler.layer(ctx.scheduler),\n              StorageReader.layer(ctx.storage),\n              StorageWriter.layer(ctx.storage),\n              QueryRunner.layer(ctx.runQuery),\n              MutationRunner.layer(ctx.runMutation),\n              Layer.succeed(\n                MutationCtx.MutationCtx<\n                  DataModel.DataModel.ToConvex<\n                    DataModel.DataModel.FromSchema<Schema>\n                  >\n                >(),\n                ctx,\n              ),\n            ),\n          ),\n        ),\n      ),\n      Effect.andThen((convexReturns) =>\n        Schema.encodeUnknown(returns)(convexReturns),\n      ),\n      Effect.runPromise,\n    ),\n});\n\nconst actionFunction = <\n  Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps,\n  ConvexValue extends DefaultFunctionArgs,\n  Value,\n  ConvexReturns,\n  Returns,\n  E,\n>({\n  args,\n  returns,\n  handler,\n}: {\n  args: Schema.Schema<Value, ConvexValue>;\n  returns: Schema.Schema<Returns, ConvexReturns>;\n  handler: (\n    a: Value,\n  ) => Effect.Effect<\n    Returns,\n    E,\n    | Scheduler.Scheduler\n    | Auth.Auth\n    | StorageReader\n    | StorageWriter\n    | StorageActionWriter\n    | QueryRunner.QueryRunner\n    | MutationRunner.MutationRunner\n    | ActionRunner.ActionRunner\n    | VectorSearch.VectorSearch<DataModel.DataModel.FromSchema<Schema>>\n    | ActionCtx.ActionCtx<\n        DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n      >\n  >;\n}) => ({\n  args: SchemaToValidator.compileArgsSchema(args),\n  returns: SchemaToValidator.compileReturnsSchema(returns),\n  handler: (\n    ctx: GenericActionCtx<\n      DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n    >,\n    actualArgs: ConvexValue,\n  ): Promise<ConvexReturns> =>\n    pipe(\n      actualArgs,\n      Schema.decode(args),\n      Effect.orDie,\n      Effect.andThen((decodedArgs) =>\n        pipe(\n          handler(decodedArgs),\n          Effect.provide(\n            Layer.mergeAll(\n              Scheduler.layer(ctx.scheduler),\n              Auth.layer(ctx.auth),\n              StorageReader.layer(ctx.storage),\n              StorageWriter.layer(ctx.storage),\n              StorageActionWriter.layer(ctx.storage),\n              QueryRunner.layer(ctx.runQuery),\n              MutationRunner.layer(ctx.runMutation),\n              ActionRunner.layer(ctx.runAction),\n              VectorSearch.layer(ctx.vectorSearch),\n              Layer.succeed(\n                ActionCtx.ActionCtx<\n                  DataModel.DataModel.ToConvex<\n                    DataModel.DataModel.FromSchema<Schema>\n                  >\n                >(),\n                ctx,\n              ),\n            ),\n          ),\n        ),\n      ),\n      Effect.andThen((convexReturns) =>\n        Schema.encodeUnknown(returns)(convexReturns),\n      ),\n      Effect.runPromise,\n    ),\n});\n\nexport declare namespace RegisteredFunctions {\n  export interface AnyWithProps {\n    readonly [key: string]: RegisteredFunction | AnyWithProps;\n  }\n\n  export type Helper<Groups extends GroupSpec.GroupSpec.AnyWithProps> = {\n    [GroupName in GroupSpec.GroupSpec.Name<Groups>]: GroupSpec.GroupSpec.WithName<\n      Groups,\n      GroupName\n    > extends infer Group extends GroupSpec.GroupSpec.AnyWithProps\n      ? GroupSpec.GroupSpec.Groups<Group> extends infer SubGroups extends\n          GroupSpec.GroupSpec.AnyWithProps\n        ? Types.Simplify<\n            Helper<SubGroups> & {\n              [FunctionName in FunctionSpec.FunctionSpec.Name<\n                GroupSpec.GroupSpec.Functions<Group>\n              >]: FunctionSpec.FunctionSpec.WithName<\n                GroupSpec.GroupSpec.Functions<Group>,\n                FunctionName\n              > extends infer Function extends\n                FunctionSpec.FunctionSpec.AnyWithProps\n                ? FunctionSpec.FunctionSpec.RegisteredFunction<Function>\n                : never;\n            }\n          >\n        : {\n            [FunctionName in FunctionSpec.FunctionSpec.Name<\n              GroupSpec.GroupSpec.Functions<Group>\n            >]: FunctionSpec.FunctionSpec.WithName<\n              GroupSpec.GroupSpec.Functions<Group>,\n              FunctionName\n            > extends infer Function extends\n              FunctionSpec.FunctionSpec.AnyWithProps\n              ? FunctionSpec.FunctionSpec.RegisteredFunction<Function>\n              : never;\n          }\n      : never;\n  };\n}\n"],"mappings":"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"}