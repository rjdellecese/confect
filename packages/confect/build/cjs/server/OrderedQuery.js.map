{"version":3,"file":"OrderedQuery.js","names":["Stream","identity","stream: OrderedQueryFunction<\"stream\">","first: OrderedQueryFunction<\"first\">","take: OrderedQueryFunction<\"take\">","Effect","Chunk","collect: OrderedQueryFunction<\"collect\">","paginate: OrderedQueryFunction<\"paginate\">"],"sources":["../../../src/server/OrderedQuery.ts"],"sourcesContent":["import type {\n  OrderedQuery as ConvexOrderedQuery,\n  PaginationResult,\n} from \"convex/server\";\nimport { Chunk, Effect, identity, type Option, pipe, Stream } from \"effect\";\nimport * as Document from \"./Document\";\nimport type * as TableInfo from \"./TableInfo\";\n\nexport type OrderedQuery<\n  TableInfo_ extends TableInfo.TableInfo.AnyWithProps,\n  _TableName extends string,\n> = {\n  readonly first: () => Effect.Effect<\n    Option.Option<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n  readonly take: (\n    n: number,\n  ) => Effect.Effect<\n    ReadonlyArray<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n  readonly collect: () => Effect.Effect<\n    ReadonlyArray<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n  readonly stream: () => Stream.Stream<\n    TableInfo_[\"document\"],\n    Document.DocumentDecodeError\n  >;\n  readonly paginate: (options: {\n    cursor: string | null;\n    numItems: number;\n  }) => Effect.Effect<\n    PaginationResult<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n};\n\nexport const make = <\n  TableInfo_ extends TableInfo.TableInfo.AnyWithProps,\n  TableName extends string,\n>(\n  query: ConvexOrderedQuery<TableInfo.TableInfo.TableInfo<TableInfo_>>,\n  tableName: TableName,\n  tableSchema: TableInfo.TableInfo.TableSchema<TableInfo_>,\n): OrderedQuery<TableInfo_, TableName> => {\n  type OrderedQueryFunction<\n    FunctionName extends keyof OrderedQuery<TableInfo_, TableName>,\n  > = OrderedQuery<TableInfo_, TableName>[FunctionName];\n\n  const streamEncoded = Stream.fromAsyncIterable(query, identity).pipe(\n    Stream.orDie,\n  );\n\n  const stream: OrderedQueryFunction<\"stream\"> = () =>\n    pipe(\n      streamEncoded,\n      Stream.mapEffect(Document.decode(tableName, tableSchema)),\n    );\n\n  const first: OrderedQueryFunction<\"first\"> = () =>\n    pipe(stream(), Stream.take(1), Stream.runHead);\n\n  const take: OrderedQueryFunction<\"take\"> = (n: number) =>\n    pipe(\n      stream(),\n      Stream.take(n),\n      Stream.runCollect,\n      Effect.map((chunk) => Chunk.toReadonlyArray(chunk)),\n    );\n\n  const collect: OrderedQueryFunction<\"collect\"> = () =>\n    pipe(stream(), Stream.runCollect, Effect.map(Chunk.toReadonlyArray));\n\n  const paginate: OrderedQueryFunction<\"paginate\"> = (options) =>\n    Effect.gen(function* () {\n      const paginationResult = yield* Effect.promise(() =>\n        query.paginate(options),\n      );\n\n      const parsedPage = yield* Effect.forEach(\n        paginationResult.page,\n        Document.decode(tableName, tableSchema),\n      );\n\n      return {\n        page: parsedPage,\n        isDone: paginationResult.isDone,\n        continueCursor: paginationResult.continueCursor,\n        /* v8 ignore start */\n        ...(paginationResult.splitCursor\n          ? { splitCursor: paginationResult.splitCursor }\n          : {}),\n        ...(paginationResult.pageStatus\n          ? { pageStatus: paginationResult.pageStatus }\n          : {}),\n        /* v8 ignore stop */\n      };\n    });\n\n  return {\n    first,\n    take,\n    collect,\n    paginate,\n    stream,\n  };\n};\n"],"mappings":";;;;;;AAuCA,MAAa,QAIX,OACA,WACA,gBACwC;CAKxC,MAAM,gBAAgBA,cAAO,kBAAkB,OAAOC,gBAAS,CAAC,KAC9DD,cAAO,MACR;CAED,MAAME,gCAEF,eACAF,cAAO,yCAA0B,WAAW,YAAY,CAAC,CAC1D;CAEH,MAAMG,+BACC,QAAQ,EAAEH,cAAO,KAAK,EAAE,EAAEA,cAAO,QAAQ;CAEhD,MAAMI,QAAsC,uBAExC,QAAQ,EACRJ,cAAO,KAAK,EAAE,EACdA,cAAO,YACPK,cAAO,KAAK,UAAUC,aAAM,gBAAgB,MAAM,CAAC,CACpD;CAEH,MAAMC,iCACC,QAAQ,EAAEP,cAAO,YAAYK,cAAO,IAAIC,aAAM,gBAAgB,CAAC;CAEtE,MAAME,YAA8C,YAClDH,cAAO,IAAI,aAAa;EACtB,MAAM,mBAAmB,OAAOA,cAAO,cACrC,MAAM,SAAS,QAAQ,CACxB;AAOD,SAAO;GACL,MANiB,OAAOA,cAAO,QAC/B,iBAAiB,qCACD,WAAW,YAAY,CACxC;GAIC,QAAQ,iBAAiB;GACzB,gBAAgB,iBAAiB;GAEjC,GAAI,iBAAiB,cACjB,EAAE,aAAa,iBAAiB,aAAa,GAC7C,EAAE;GACN,GAAI,iBAAiB,aACjB,EAAE,YAAY,iBAAiB,YAAY,GAC3C,EAAE;GAEP;GACD;AAEJ,QAAO;EACL;EACA;EACA;EACA;EACA;EACD"}