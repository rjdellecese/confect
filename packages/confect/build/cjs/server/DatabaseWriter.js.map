{"version":3,"file":"DatabaseWriter.js","names":["Effect","Record","Context","Layer"],"sources":["../../../src/server/DatabaseWriter.ts"],"sourcesContent":["import type {\n  BetterOmit,\n  DocumentByName,\n  Expand,\n  GenericDatabaseWriter,\n  WithoutSystemFields,\n} from \"convex/server\";\nimport type { GenericId } from \"convex/values\";\nimport { Context, Effect, Layer, pipe, Record } from \"effect\";\nimport type * as DatabaseSchema from \"./DatabaseSchema\";\nimport type * as DataModel from \"./DataModel\";\nimport type { DocumentByName as DocumentByName_ } from \"./DataModel\";\nimport * as Document from \"./Document\";\nimport * as QueryInitializer from \"./QueryInitializer\";\nimport type * as Table from \"./Table\";\nimport type * as TableInfo from \"./TableInfo\";\n\nexport const make = <Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps>(\n  schema: Schema,\n  convexDatabaseWriter: GenericDatabaseWriter<\n    DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n  >,\n) => {\n  type DataModel_ = DataModel.DataModel.FromSchema<Schema>;\n\n  const insert = <TableName extends DataModel.DataModel.TableNames<DataModel_>>(\n    tableName: TableName,\n    document: Document.Document.WithoutSystemFields<\n      DocumentByName_<DataModel_, TableName>\n    >,\n  ) =>\n    Effect.gen(function* () {\n      const table = (schema.tables as Record<string, Table.Table.AnyWithProps>)[\n        tableName\n      ]!;\n\n      const encodedDocument = yield* Document.encode(\n        document,\n        tableName,\n        table.Fields,\n      );\n\n      const id = yield* Effect.promise(() =>\n        convexDatabaseWriter.insert(\n          tableName,\n          encodedDocument as WithoutSystemFields<\n            DocumentByName<DataModel.DataModel.ToConvex<DataModel_>, TableName>\n          >,\n        ),\n      );\n\n      return id;\n    });\n\n  const patch = <TableName extends DataModel.DataModel.TableNames<DataModel_>>(\n    tableName: TableName,\n    id: GenericId<TableName>,\n    patchedValues: Partial<\n      WithoutSystemFields<DocumentByName_<DataModel_, TableName>>\n    >,\n  ) =>\n    Effect.gen(function* () {\n      const table = (schema.tables as Record<string, Table.Table.AnyWithProps>)[\n        tableName\n      ]!;\n\n      const tableSchema = table.Fields as TableInfo.TableInfo.TableSchema<\n        DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n      >;\n\n      const originalDecodedDoc = yield* QueryInitializer.getById(\n        tableName,\n        convexDatabaseWriter as any,\n        table,\n      )(id);\n\n      const updatedEncodedDoc = yield* pipe(\n        patchedValues,\n        Record.reduce(originalDecodedDoc, (acc, value, key) =>\n          value === undefined\n            ? Record.remove(acc, key)\n            : Record.set(acc, key, value),\n        ),\n        Document.encode(tableName, tableSchema),\n      );\n\n      yield* Effect.promise(() =>\n        convexDatabaseWriter.replace(\n          id,\n          updatedEncodedDoc as Expand<\n            BetterOmit<\n              DocumentByName<\n                DataModel.DataModel.ToConvex<DataModel_>,\n                TableName\n              >,\n              \"_creationTime\" | \"_id\"\n            >\n          >,\n        ),\n      );\n    });\n\n  const replace = <\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    tableName: TableName,\n    id: GenericId<TableName>,\n    value: WithoutSystemFields<DocumentByName_<DataModel_, TableName>>,\n  ) =>\n    Effect.gen(function* () {\n      const table = (schema.tables as Record<string, Table.Table.AnyWithProps>)[\n        tableName\n      ]!;\n\n      const tableSchema = table.Fields as TableInfo.TableInfo.TableSchema<\n        DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n      >;\n\n      const updatedEncodedDoc = yield* Document.encode(\n        value,\n        tableName,\n        tableSchema,\n      );\n\n      yield* Effect.promise(() =>\n        convexDatabaseWriter.replace(\n          id,\n          updatedEncodedDoc as Expand<\n            BetterOmit<\n              DocumentByName<\n                DataModel.DataModel.ToConvex<DataModel_>,\n                TableName\n              >,\n              \"_creationTime\" | \"_id\"\n            >\n          >,\n        ),\n      );\n    });\n\n  const delete_ = <\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    _tableName: TableName,\n    id: GenericId<TableName>,\n  ) => Effect.promise(() => convexDatabaseWriter.delete(id));\n\n  return {\n    insert,\n    patch,\n    replace,\n    delete: delete_,\n  };\n};\n\nexport const DatabaseWriter = <\n  Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps,\n>() =>\n  Context.GenericTag<ReturnType<typeof make<Schema>>>(\n    \"@rjdellecese/confect/server/DatabaseWriter\",\n  );\n\nexport type DatabaseWriter<\n  Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps,\n> = ReturnType<typeof DatabaseWriter<Schema>>[\"Identifier\"];\n\nexport const layer = <\n  Schema extends DatabaseSchema.DatabaseSchema.AnyWithProps,\n>(\n  schema: Schema,\n  convexDatabaseWriter: GenericDatabaseWriter<\n    DataModel.DataModel.ToConvex<DataModel.DataModel.FromSchema<Schema>>\n  >,\n) =>\n  Layer.succeed(DatabaseWriter<Schema>(), make(schema, convexDatabaseWriter));\n"],"mappings":";;;;;;;;;;;AAiBA,MAAa,QACX,QACA,yBAGG;CAGH,MAAM,UACJ,WACA,aAIAA,cAAO,IAAI,aAAa;EACtB,MAAM,QAAS,OAAO,OACpB;EAGF,MAAM,kBAAkB,sCACtB,UACA,WACA,MAAM,OACP;AAWD,SATW,OAAOA,cAAO,cACvB,qBAAqB,OACnB,WACA,gBAGD,CACF;GAGD;CAEJ,MAAM,SACJ,WACA,IACA,kBAIAA,cAAO,IAAI,aAAa;EACtB,MAAM,QAAS,OAAO,OACpB;EAGF,MAAM,cAAc,MAAM;EAI1B,MAAM,qBAAqB,+CACzB,WACA,sBACA,MACD,CAAC,GAAG;EAEL,MAAM,oBAAoB,wBACxB,eACAC,cAAO,OAAO,qBAAqB,KAAK,OAAO,QAC7C,UAAU,SACNA,cAAO,OAAO,KAAK,IAAI,GACvBA,cAAO,IAAI,KAAK,KAAK,MAAM,CAChC,iCACe,WAAW,YAAY,CACxC;AAED,SAAOD,cAAO,cACZ,qBAAqB,QACnB,IACA,kBASD,CACF;GACD;CAEJ,MAAM,WAGJ,WACA,IACA,UAEAA,cAAO,IAAI,aAAa;EAKtB,MAAM,cAJS,OAAO,OACpB,WAGwB;EAI1B,MAAM,oBAAoB,sCACxB,OACA,WACA,YACD;AAED,SAAOA,cAAO,cACZ,qBAAqB,QACnB,IACA,kBASD,CACF;GACD;CAEJ,MAAM,WAGJ,YACA,OACGA,cAAO,cAAc,qBAAqB,OAAO,GAAG,CAAC;AAE1D,QAAO;EACL;EACA;EACA;EACA,QAAQ;EACT;;AAGH,MAAa,uBAGXE,eAAQ,WACN,6CACD;AAMH,MAAa,SAGX,QACA,yBAIAC,aAAM,QAAQ,gBAAwB,EAAE,KAAK,QAAQ,qBAAqB,CAAC"}