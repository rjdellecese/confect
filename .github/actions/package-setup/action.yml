name: "Monorepo Setup"
description: "Sets up Node.js and pnpm and installs dependencies for the entire monorepo"
author: "Confect"

runs:
  using: "composite"
  steps:
    - name: Get pnpm version from package.json
      id: pnpm-version
      shell: bash
      run: echo "pnpm_version=$(node -p 'require(`./package.json`).engines.pnpm')" >> $GITHUB_OUTPUT

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ steps.pnpm-version.outputs.pnpm_version }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: "package.json"
        cache: "pnpm"

    - name: Install dependencies
      run: pnpm install
      shell: bash

    - name: Generate Convex types (confect)
      run: pnpm --filter @rjdellecese/confect convex-codegen
      shell: bash

    - name: Generate Convex types (example)
      run: pnpm --filter example convex-codegen
      shell: bash