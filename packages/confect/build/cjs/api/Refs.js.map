{"version":3,"file":"Refs.js","names":["Record"],"sources":["../../../src/api/Refs.ts"],"sourcesContent":["import type { Schema, Types } from \"effect\";\nimport { pipe, Record } from \"effect\";\nimport type * as FunctionSpec from \"./FunctionSpec\";\nimport type * as GroupSpec from \"./GroupSpec\";\nimport type * as Spec from \"./Spec\";\n\nexport type Refs<Spec_ extends Spec.Spec.AnyWithProps> = Types.Simplify<\n  Helper<Spec.Spec.Groups<Spec_>>\n>;\n\ntype Helper<Groups extends GroupSpec.GroupSpec.AnyWithProps> = {\n  [GroupName in GroupSpec.GroupSpec.Name<Groups>]: GroupSpec.GroupSpec.WithName<\n    Groups,\n    GroupName\n  > extends infer Group extends GroupSpec.GroupSpec.AnyWithProps\n    ? GroupSpec.GroupSpec.Groups<Group> extends infer SubGroups extends\n        GroupSpec.GroupSpec.AnyWithProps\n      ? Types.Simplify<\n          Helper<SubGroups> & {\n            [FunctionName in FunctionSpec.FunctionSpec.Name<\n              GroupSpec.GroupSpec.Functions<Group>\n            >]: FunctionSpec.FunctionSpec.WithName<\n              GroupSpec.GroupSpec.Functions<Group>,\n              FunctionName\n            > extends infer Function extends\n              FunctionSpec.FunctionSpec.AnyWithProps\n              ? Ref<\n                  FunctionSpec.FunctionSpec.GetFunctionType<Function>,\n                  FunctionSpec.FunctionSpec.GetFunctionVisibility<Function>,\n                  FunctionSpec.FunctionSpec.Args<Function>,\n                  FunctionSpec.FunctionSpec.Returns<Function>\n                >\n              : never;\n          }\n        >\n      : never\n    : never;\n};\n\ntype FilterRefs<Refs_, Predicate> = Types.Simplify<{\n  [K in keyof Refs_ as Refs_[K] extends Predicate\n    ? K\n    : Refs_[K] extends Ref.Any\n      ? never\n      : FilterRefs<Refs_[K], Predicate> extends Record<string, never>\n        ? never\n        : K]: Refs_[K] extends Predicate\n    ? Refs_[K]\n    : FilterRefs<Refs_[K], Predicate>;\n}>;\n\nexport const justInternal = <Refs_ extends Refs.AnyWithProps>(\n  refs: Refs_,\n): FilterRefs<Refs_, Ref.AnyInternal> => refs as any;\n\nexport const justPublic = <Refs_ extends Refs.AnyWithProps>(\n  refs: Refs_,\n): FilterRefs<Refs_, Ref.AnyPublic> => refs as any;\n\nexport declare namespace Refs {\n  export type AnyWithProps =\n    | {\n        readonly [key: string]: Refs.AnyWithProps;\n      }\n    | Ref.Any;\n}\n\nconst HiddenFunctionKey = \"@rjdellecese/confect/api/HiddenFunctionKey\";\ntype HiddenFunctionKey = typeof HiddenFunctionKey;\ntype HiddenFunction<Ref_ extends Ref.Any> = FunctionSpec.FunctionSpec<\n  Ref.FunctionType<Ref_>,\n  Ref.FunctionVisibility<Ref_>,\n  string,\n  Ref.Args<Ref_>,\n  Ref.Returns<Ref_>\n>;\n\nexport const getFunction = <\n  FunctionType extends FunctionSpec.FunctionSpec.FunctionType,\n  FunctionVisibility extends FunctionSpec.FunctionSpec.FunctionVisibility,\n  Args extends Schema.Schema.AnyNoContext,\n  Returns extends Schema.Schema.AnyNoContext,\n  Ref_ extends Ref<FunctionType, FunctionVisibility, Args, Returns>,\n>(\n  ref: Ref_,\n): HiddenFunction<Ref_> => (ref as any)[HiddenFunctionKey];\n\nconst HiddenConvexFunctionNameKey =\n  \"@rjdellecese/confect/api/HiddenConvexFunctionNameKey\";\ntype HiddenConvexFunctionNameKey = typeof HiddenConvexFunctionNameKey;\ntype HiddenConvexFunctionName = string;\n\nexport const getConvexFunctionName = <\n  FunctionType extends FunctionSpec.FunctionSpec.FunctionType,\n  FunctionVisibility extends FunctionSpec.FunctionSpec.FunctionVisibility,\n  Args extends Schema.Schema.AnyNoContext,\n  Returns extends Schema.Schema.AnyNoContext,\n>(\n  ref: Ref<FunctionType, FunctionVisibility, Args, Returns>,\n): HiddenConvexFunctionName => (ref as any)[HiddenConvexFunctionNameKey];\n\nexport interface Ref<\n  _FunctionType extends FunctionSpec.FunctionSpec.FunctionType,\n  _FunctionVisibility extends FunctionSpec.FunctionSpec.FunctionVisibility,\n  _Args extends Schema.Schema.AnyNoContext,\n  _Returns extends Schema.Schema.AnyNoContext,\n> {\n  readonly _FunctionType?: _FunctionType;\n  readonly _FunctionVisibility?: _FunctionVisibility;\n  readonly _Args?: _Args;\n  readonly _Returns?: _Returns;\n}\n\nexport declare namespace Ref {\n  export interface Any extends Ref<any, any, any, any> {}\n\n  export interface AnyInternal extends Ref<any, \"Internal\", any, any> {}\n\n  export interface AnyPublic extends Ref<any, \"Public\", any, any> {}\n\n  export interface AnyQuery\n    extends Ref<\n      \"Query\",\n      FunctionSpec.FunctionSpec.FunctionVisibility,\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  export interface AnyMutation\n    extends Ref<\n      \"Query\",\n      FunctionSpec.FunctionSpec.FunctionVisibility,\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  export interface AnyAction\n    extends Ref<\n      \"Action\",\n      FunctionSpec.FunctionSpec.FunctionVisibility,\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  export interface AnyPublicQuery\n    extends Ref<\n      \"Query\",\n      \"Public\",\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  export interface AnyPublicMutation\n    extends Ref<\n      \"Mutation\",\n      \"Public\",\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  export interface AnyPublicAction\n    extends Ref<\n      \"Action\",\n      \"Public\",\n      Schema.Schema.AnyNoContext,\n      Schema.Schema.AnyNoContext\n    > {}\n\n  export type FunctionType<Ref_> =\n    Ref_ extends Ref<\n      infer FunctionType_,\n      infer _FunctionVisibility,\n      infer _Args,\n      infer _Returns\n    >\n      ? FunctionType_\n      : never;\n\n  export type FunctionVisibility<Ref_> =\n    Ref_ extends Ref<\n      infer _FunctionType,\n      infer FunctionVisibility_,\n      infer _Args,\n      infer _Returns\n    >\n      ? FunctionVisibility_\n      : never;\n\n  export type Args<Ref_> =\n    Ref_ extends Ref<\n      infer _FunctionType,\n      infer _FunctionVisibility,\n      infer Args_,\n      infer _Returns\n    >\n      ? Args_\n      : never;\n\n  export type Returns<Ref_> =\n    Ref_ extends Ref<\n      infer _FunctionType,\n      infer _FunctionVisibility,\n      infer _Args,\n      infer Returns_\n    >\n      ? Returns_\n      : never;\n}\n\nconst makeRef = <\n  FunctionType extends FunctionSpec.FunctionSpec.FunctionType,\n  FunctionVisibility extends FunctionSpec.FunctionSpec.FunctionVisibility,\n  Args extends Schema.Schema.AnyNoContext,\n  Returns extends Schema.Schema.AnyNoContext,\n>(\n  /**\n   * This is a Convex \"function name\" of the format \"myGroupDir/myGroupMod:myFunc\".\n   */\n  convexFunctionName: string,\n  function_: FunctionSpec.FunctionSpec<\n    FunctionType,\n    FunctionVisibility,\n    string,\n    Args,\n    Returns\n  >,\n): Ref<FunctionType, FunctionVisibility, Args, Returns> =>\n  ({\n    [HiddenFunctionKey]: function_,\n    [HiddenConvexFunctionNameKey]: convexFunctionName,\n  }) as Ref<FunctionType, FunctionVisibility, Args, Returns>;\n\nexport const make = <Spec_ extends Spec.Spec.AnyWithProps>(\n  spec: Spec_,\n): Refs<Spec_> => makeHelper(spec.groups) as Refs<Spec_>;\n\nconst makeHelper = (\n  groups: Record.ReadonlyRecord<string, GroupSpec.GroupSpec.Any>,\n  groupPath: string | null = null,\n): Refs.AnyWithProps =>\n  pipe(\n    groups as Record.ReadonlyRecord<string, GroupSpec.GroupSpec.AnyWithProps>,\n    Record.map((group) => {\n      const currentGroupPath = groupPath\n        ? `${groupPath}/${group.name}`\n        : group.name;\n\n      return Record.union(\n        makeHelper(group.groups, currentGroupPath),\n        Record.map(group.functions, (function_) =>\n          makeRef(`${currentGroupPath}:${function_.name}`, function_),\n        ),\n        (_subGroup, _function) => {\n          throw new Error(\n            `Group and function at same level have same name ('${getConvexFunctionName(_function)}')`,\n          );\n        },\n      );\n    }),\n  );\n"],"mappings":";;;;;;;;;;;AAmDA,MAAa,gBACX,SACuC;AAEzC,MAAa,cACX,SACqC;AAUvC,MAAM,oBAAoB;AAU1B,MAAa,eAOX,QAC0B,IAAY;AAExC,MAAM,8BACJ;AAIF,MAAa,yBAMX,QAC8B,IAAY;AA8G5C,MAAM,WASJ,oBACA,eAQC;EACE,oBAAoB;EACpB,8BAA8B;CAChC;AAEH,MAAa,QACX,SACgB,WAAW,KAAK,OAAO;AAEzC,MAAM,cACJ,QACA,YAA2B,0BAGzB,QACAA,cAAO,KAAK,UAAU;CACpB,MAAM,mBAAmB,YACrB,GAAG,UAAU,GAAG,MAAM,SACtB,MAAM;AAEV,QAAOA,cAAO,MACZ,WAAW,MAAM,QAAQ,iBAAiB,EAC1CA,cAAO,IAAI,MAAM,YAAY,cAC3B,QAAQ,GAAG,iBAAiB,GAAG,UAAU,QAAQ,UAAU,CAC5D,GACA,WAAW,cAAc;AACxB,QAAM,IAAI,MACR,qDAAqD,sBAAsB,UAAU,CAAC,IACvF;GAEJ;EACD,CACH"}