{"version":3,"file":"Document.js","names":["SystemFields.extendWithSystemFields"],"sources":["../../../src/server/Document.ts"],"sourcesContent":["import { Effect, Function, ParseResult, pipe, Schema } from \"effect\";\nimport type { ReadonlyRecord } from \"effect/Record\";\nimport * as SystemFields from \"../api/SystemFields\";\nimport type * as DataModel from \"./DataModel\";\nimport type { ReadonlyValue } from \"./SchemaToValidator\";\nimport type * as TableInfo from \"./TableInfo\";\n\nexport declare namespace Document {\n  export type WithoutSystemFields<Doc> = Omit<Doc, \"_creationTime\" | \"_id\">;\n\n  export type Any = any;\n  export type AnyEncoded = ReadonlyRecord<string, ReadonlyValue>;\n}\n\nexport const decode = Function.dual<\n  <\n    DataModel_ extends DataModel.DataModel.AnyWithProps,\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    tableName: TableName,\n    tableSchema: TableInfo.TableInfo.TableSchema<\n      DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n    >,\n  ) => (\n    self: DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"convexDocument\"],\n  ) => Effect.Effect<\n    DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>[\"document\"],\n    DocumentDecodeError\n  >,\n  <\n    DataModel_ extends DataModel.DataModel.AnyWithProps,\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    self: DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"convexDocument\"],\n    tableName: TableName,\n    tableSchema: TableInfo.TableInfo.TableSchema<\n      DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n    >,\n  ) => Effect.Effect<\n    DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>[\"document\"],\n    DocumentDecodeError\n  >\n>(\n  3,\n  <\n    DataModel_ extends DataModel.DataModel.AnyWithProps,\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    self: DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"convexDocument\"],\n    tableName: TableName,\n    tableSchema: TableInfo.TableInfo.TableSchema<\n      DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n    >,\n  ): Effect.Effect<\n    DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>[\"document\"],\n    DocumentDecodeError\n  > =>\n    Effect.gen(function* () {\n      const TableSchemaWithSystemFields = SystemFields.extendWithSystemFields(\n        tableName,\n        tableSchema,\n      );\n\n      const encodedDoc =\n        self as (typeof TableSchemaWithSystemFields)[\"Encoded\"];\n\n      const decodedDoc = yield* pipe(\n        encodedDoc,\n        Schema.decode(TableSchemaWithSystemFields),\n        Effect.catchTag(\"ParseError\", (parseError) =>\n          Effect.gen(function* () {\n            const formattedParseError =\n              yield* ParseResult.TreeFormatter.formatError(parseError);\n\n            return yield* new DocumentDecodeError({\n              tableName,\n              id: encodedDoc._id,\n              parseError: formattedParseError,\n            });\n          }),\n        ),\n      );\n\n      return decodedDoc;\n    }),\n);\n\nexport const encode = Function.dual<\n  <\n    DataModel_ extends DataModel.DataModel.AnyWithProps,\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    tableName: TableName,\n    tableSchema: TableInfo.TableInfo.TableSchema<\n      DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n    >,\n  ) => (\n    self: DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"document\"],\n  ) => Effect.Effect<\n    DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"encodedDocument\"],\n    DocumentEncodeError\n  >,\n  <\n    DataModel_ extends DataModel.DataModel.AnyWithProps,\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    self: DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"document\"],\n    tableName: TableName,\n    tableSchema: TableInfo.TableInfo.TableSchema<\n      DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n    >,\n  ) => Effect.Effect<\n    DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"encodedDocument\"],\n    DocumentEncodeError\n  >\n>(\n  3,\n  <\n    DataModel_ extends DataModel.DataModel.AnyWithProps,\n    TableName extends DataModel.DataModel.TableNames<DataModel_>,\n  >(\n    self: DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"document\"],\n    tableName: TableName,\n    tableSchema: TableInfo.TableInfo.TableSchema<\n      DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n    >,\n  ): Effect.Effect<\n    DataModel.DataModel.TableInfoWithName_<\n      DataModel_,\n      TableName\n    >[\"encodedDocument\"],\n    DocumentEncodeError\n  > =>\n    Effect.gen(function* () {\n      type TableSchemaWithSystemFields = SystemFields.ExtendWithSystemFields<\n        TableName,\n        TableInfo.TableInfo.TableSchema<\n          DataModel.DataModel.TableInfoWithName_<DataModel_, TableName>\n        >\n      >;\n\n      const decodedDoc = self as TableSchemaWithSystemFields[\"Type\"];\n\n      const encodedDoc = yield* pipe(\n        decodedDoc,\n        Schema.encode(tableSchema),\n        Effect.catchTag(\"ParseError\", (parseError) =>\n          Effect.gen(function* () {\n            const formattedParseError =\n              yield* ParseResult.TreeFormatter.formatError(parseError);\n\n            return yield* new DocumentEncodeError({\n              tableName,\n              id: decodedDoc._id,\n              parseError: formattedParseError,\n            });\n          }),\n        ),\n      );\n\n      return encodedDoc;\n    }),\n);\n\nexport class DocumentDecodeError extends Schema.TaggedError<DocumentDecodeError>(\n  \"DocumentDecodeError\",\n)(\"DocumentDecodeError\", {\n  tableName: Schema.String,\n  id: Schema.String,\n  parseError: Schema.String,\n}) {\n  override get message(): string {\n    return documentErrorMessage({\n      id: this.id,\n      tableName: this.tableName,\n      message: `could not be decoded:\\n\\n${this.parseError}`,\n    });\n  }\n}\n\nexport class DocumentEncodeError extends Schema.TaggedError<DocumentEncodeError>(\n  \"DocumentEncodeError\",\n)(\"DocumentEncodeError\", {\n  tableName: Schema.String,\n  id: Schema.String,\n  parseError: Schema.String,\n}) {\n  override get message(): string {\n    return documentErrorMessage({\n      id: this.id,\n      tableName: this.tableName,\n      message: `could not be encoded:\\n\\n${this.parseError}`,\n    });\n  }\n}\n\nexport const documentErrorMessage = ({\n  id,\n  tableName,\n  message,\n}: {\n  id: string;\n  tableName: string;\n  message: string;\n}) => `Document with ID '${id}' in table '${tableName}' ${message}`;\n"],"mappings":";;;;;;;;;;;;AAcA,MAAa,SAAS,SAAS,KAmC7B,IAKE,MAIA,WACA,gBAOA,OAAO,IAAI,aAAa;CACtB,MAAM,8BAA8BA,uBAClC,WACA,YACD;CAED,MAAM,aACJ;AAmBF,QAjBmB,OAAO,KACxB,YACA,OAAO,OAAO,4BAA4B,EAC1C,OAAO,SAAS,eAAe,eAC7B,OAAO,IAAI,aAAa;EACtB,MAAM,sBACJ,OAAO,YAAY,cAAc,YAAY,WAAW;AAE1D,SAAO,OAAO,IAAI,oBAAoB;GACpC;GACA,IAAI,WAAW;GACf,YAAY;GACb,CAAC;GACF,CACH,CACF;EAGD,CACL;AAED,MAAa,SAAS,SAAS,KAyC7B,IAKE,MAIA,WACA,gBAUA,OAAO,IAAI,aAAa;CAQtB,MAAM,aAAa;AAmBnB,QAjBmB,OAAO,KACxB,YACA,OAAO,OAAO,YAAY,EAC1B,OAAO,SAAS,eAAe,eAC7B,OAAO,IAAI,aAAa;EACtB,MAAM,sBACJ,OAAO,YAAY,cAAc,YAAY,WAAW;AAE1D,SAAO,OAAO,IAAI,oBAAoB;GACpC;GACA,IAAI,WAAW;GACf,YAAY;GACb,CAAC;GACF,CACH,CACF;EAGD,CACL;AAED,IAAa,sBAAb,cAAyC,OAAO,YAC9C,sBACD,CAAC,uBAAuB;CACvB,WAAW,OAAO;CAClB,IAAI,OAAO;CACX,YAAY,OAAO;CACpB,CAAC,CAAC;CACD,IAAa,UAAkB;AAC7B,SAAO,qBAAqB;GAC1B,IAAI,KAAK;GACT,WAAW,KAAK;GAChB,SAAS,4BAA4B,KAAK;GAC3C,CAAC;;;AAIN,IAAa,sBAAb,cAAyC,OAAO,YAC9C,sBACD,CAAC,uBAAuB;CACvB,WAAW,OAAO;CAClB,IAAI,OAAO;CACX,YAAY,OAAO;CACpB,CAAC,CAAC;CACD,IAAa,UAAkB;AAC7B,SAAO,qBAAqB;GAC1B,IAAI,KAAK;GACT,WAAW,KAAK;GAChB,SAAS,4BAA4B,KAAK;GAC3C,CAAC;;;AAIN,MAAa,wBAAwB,EACnC,IACA,WACA,cAKI,qBAAqB,GAAG,cAAc,UAAU,IAAI"}