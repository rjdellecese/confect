{"version":3,"file":"HttpApi.js","names":["Layer","StorageReader","StorageWriter","StorageActionWriter","HttpApiScalar","HttpServer","HttpApiBuilder","ROUTABLE_HTTP_METHODS","routeSpec: RouteSpecWithPathPrefix","Record","Array"],"sources":["../../../src/server/HttpApi.ts"],"sourcesContent":["import {\n  type HttpApi,\n  HttpApiBuilder,\n  HttpApiScalar,\n  type HttpApp,\n  type HttpRouter,\n  HttpServer,\n} from \"@effect/platform\";\nimport {\n  type HttpRouter as ConvexHttpRouter,\n  type GenericActionCtx,\n  type GenericDataModel,\n  httpActionGeneric,\n  httpRouter,\n  ROUTABLE_HTTP_METHODS,\n  type RouteSpecWithPathPrefix,\n} from \"convex/server\";\nimport { Array, Layer, pipe, Record } from \"effect\";\nimport * as ActionRunner from \"./ActionRunner\";\nimport * as Auth from \"./Auth\";\nimport * as MutationRunner from \"./MutationRunner\";\nimport * as QueryRunner from \"./QueryRunner\";\nimport * as Scheduler from \"./Scheduler\";\nimport { StorageActionWriter, StorageReader, StorageWriter } from \"./Storage\";\nimport * as ActionCtx from \"./ActionCtx\";\n\ntype Middleware = (\n  httpApp: HttpApp.Default,\n) => HttpApp.Default<\n  never,\n  HttpApi.Api | HttpApiBuilder.Router | HttpRouter.HttpRouter.DefaultServices\n>;\n\nconst makeHandler =\n  <DataModel extends GenericDataModel>({\n    pathPrefix,\n    apiLive,\n    middleware,\n    scalar,\n  }: {\n    pathPrefix: RoutePath;\n    apiLive: Layer.Layer<\n      HttpApi.Api,\n      never,\n      | QueryRunner.QueryRunner\n      | MutationRunner.MutationRunner\n      | ActionRunner.ActionRunner\n      | Scheduler.Scheduler\n      | Auth.Auth\n      | StorageReader\n      | StorageWriter\n      | StorageActionWriter\n      | GenericActionCtx<DataModel>\n    >;\n    middleware?: Middleware;\n    scalar?: HttpApiScalar.ScalarConfig;\n  }) =>\n  (ctx: GenericActionCtx<DataModel>, request: Request): Promise<Response> => {\n    const ApiLive = apiLive.pipe(\n      Layer.provide(\n        Layer.mergeAll(\n          QueryRunner.layer(ctx.runQuery),\n          MutationRunner.layer(ctx.runMutation),\n          ActionRunner.layer(ctx.runAction),\n          Scheduler.layer(ctx.scheduler),\n          Auth.layer(ctx.auth),\n          StorageReader.layer(ctx.storage),\n          StorageWriter.layer(ctx.storage),\n          StorageActionWriter.layer(ctx.storage),\n          Layer.succeed(ActionCtx.ActionCtx<DataModel>(), ctx),\n        ),\n      ),\n    );\n\n    const ApiDocsLive = HttpApiScalar.layer({\n      path: `${pathPrefix}docs`,\n      scalar: {\n        baseServerURL: `${process.env[\"CONVEX_SITE_URL\"]}${pathPrefix}`,\n        ...scalar,\n      },\n    }).pipe(Layer.provide(ApiLive));\n\n    const EnvLive = Layer.mergeAll(\n      ApiLive,\n      ApiDocsLive,\n      HttpServer.layerContext,\n    );\n\n    const { handler } = HttpApiBuilder.toWebHandler(\n      EnvLive,\n      middleware ? { middleware } : {},\n    );\n\n    return handler(request);\n  };\n\nconst makeHttpAction = <DataModel extends GenericDataModel>({\n  pathPrefix,\n  apiLive,\n  middleware,\n  scalar,\n}: {\n  pathPrefix: RoutePath;\n  apiLive: Layer.Layer<\n    HttpApi.Api,\n    never,\n    | QueryRunner.QueryRunner\n    | MutationRunner.MutationRunner\n    | ActionRunner.ActionRunner\n    | Scheduler.Scheduler\n    | Auth.Auth\n    | StorageReader\n    | StorageWriter\n    | StorageActionWriter\n    | GenericActionCtx<DataModel>\n  >;\n  middleware?: Middleware;\n  scalar?: HttpApiScalar.ScalarConfig;\n}) =>\n  httpActionGeneric(\n    makeHandler<DataModel>({\n      pathPrefix,\n      apiLive,\n      ...(middleware ? { middleware } : {}),\n      ...(scalar ? { scalar } : {}),\n    }) as unknown as (\n      ctx: GenericActionCtx<GenericDataModel>,\n      request: Request,\n    ) => Promise<Response>,\n  );\n\nexport type HttpApi_ = {\n  apiLive: Layer.Layer<\n    HttpApi.Api,\n    never,\n    | QueryRunner.QueryRunner\n    | MutationRunner.MutationRunner\n    | ActionRunner.ActionRunner\n    | Scheduler.Scheduler\n    | Auth.Auth\n    | StorageReader\n    | StorageWriter\n    | StorageActionWriter\n  >;\n  middleware?: Middleware;\n  scalar?: HttpApiScalar.ScalarConfig;\n};\n\nexport type RoutePath = \"/\" | `/${string}/`;\n\nconst mountEffectHttpApi =\n  <DataModel extends GenericDataModel>({\n    pathPrefix,\n    apiLive,\n    middleware,\n    scalar,\n  }: {\n    pathPrefix: RoutePath;\n    apiLive: Layer.Layer<\n      HttpApi.Api,\n      never,\n      | QueryRunner.QueryRunner\n      | MutationRunner.MutationRunner\n      | ActionRunner.ActionRunner\n      | Scheduler.Scheduler\n      | Auth.Auth\n      | StorageReader\n      | StorageWriter\n      | StorageActionWriter\n      | GenericActionCtx<DataModel>\n    >;\n    middleware?: Middleware;\n    scalar?: HttpApiScalar.ScalarConfig;\n  }) =>\n  (convexHttpRouter: ConvexHttpRouter): ConvexHttpRouter => {\n    const handler = makeHttpAction<DataModel>({\n      pathPrefix,\n      apiLive,\n      ...(middleware ? { middleware } : {}),\n      ...(scalar ? { scalar } : {}),\n    });\n\n    Array.forEach(ROUTABLE_HTTP_METHODS, (method) => {\n      const routeSpec: RouteSpecWithPathPrefix = {\n        pathPrefix,\n        method,\n        handler,\n      };\n      convexHttpRouter.route(routeSpec);\n    });\n\n    return convexHttpRouter;\n  };\n\ntype HttpApis = Partial<Record<RoutePath, HttpApi_>>;\n\nexport const make = (httpApis: HttpApis): ConvexHttpRouter => {\n  applyMonkeyPatches();\n\n  return pipe(\n    httpApis as Record<RoutePath, HttpApi_>,\n    Record.toEntries,\n    Array.reduce(\n      httpRouter(),\n      (convexHttpRouter, [pathPrefix, { apiLive, middleware, scalar }]) =>\n        mountEffectHttpApi({\n          pathPrefix: pathPrefix as RoutePath,\n          apiLive,\n          ...(middleware ? { middleware } : {}),\n          ...(scalar ? { scalar } : {}),\n        })(convexHttpRouter),\n    ),\n  );\n};\n\nconst applyMonkeyPatches = () => {\n  // These are necessary until the Convex runtime supports these APIs. See https://discord.com/channels/1019350475847499849/1281364098419785760\n\n  // eslint-disable-next-line no-global-assign\n  URL = class extends URL {\n    override get username() {\n      return \"\";\n    }\n    override get password() {\n      return \"\";\n    }\n  };\n\n  Object.defineProperty(Request.prototype, \"signal\", {\n    get: () => new AbortSignal(),\n  });\n};\n"],"mappings":";;;;;;;;;;;;;;AAiCA,MAAM,eACiC,EACnC,YACA,SACA,YACA,cAmBD,KAAkC,YAAwC;CACzE,MAAM,UAAU,QAAQ,KACtBA,aAAM,QACJA,aAAM,0CACc,IAAI,SAAS,sCACV,IAAI,YAAY,oCAClB,IAAI,UAAU,iCACjB,IAAI,UAAU,4BACnB,IAAI,KAAK,EACpBC,qCAAc,MAAM,IAAI,QAAQ,EAChCC,qCAAc,MAAM,IAAI,QAAQ,EAChCC,2CAAoB,MAAM,IAAI,QAAQ,EACtCH,aAAM,4CAAwC,EAAE,IAAI,CACrD,CACF,CACF;CAED,MAAM,cAAcI,gCAAc,MAAM;EACtC,MAAM,GAAG,WAAW;EACpB,QAAQ;GACN,eAAe,GAAG,QAAQ,IAAI,qBAAqB;GACnD,GAAG;GACJ;EACF,CAAC,CAAC,KAAKJ,aAAM,QAAQ,QAAQ,CAAC;CAE/B,MAAM,UAAUA,aAAM,SACpB,SACA,aACAK,6BAAW,aACZ;CAED,MAAM,EAAE,YAAYC,iCAAe,aACjC,SACA,aAAa,EAAE,YAAY,GAAG,EAAE,CACjC;AAED,QAAO,QAAQ,QAAQ;;AAG3B,MAAM,kBAAsD,EAC1D,YACA,SACA,YACA,kDAoBE,YAAuB;CACrB;CACA;CACA,GAAI,aAAa,EAAE,YAAY,GAAG,EAAE;CACpC,GAAI,SAAS,EAAE,QAAQ,GAAG,EAAE;CAC7B,CAAC,CAIH;AAqBH,MAAM,sBACiC,EACnC,YACA,SACA,YACA,cAmBD,qBAAyD;CACxD,MAAM,UAAU,eAA0B;EACxC;EACA;EACA,GAAI,aAAa,EAAE,YAAY,GAAG,EAAE;EACpC,GAAI,SAAS,EAAE,QAAQ,GAAG,EAAE;EAC7B,CAAC;AAEF,cAAM,QAAQC,sCAAwB,WAAW;EAC/C,MAAMC,YAAqC;GACzC;GACA;GACA;GACD;AACD,mBAAiB,MAAM,UAAU;GACjC;AAEF,QAAO;;AAKX,MAAa,QAAQ,aAAyC;AAC5D,qBAAoB;AAEpB,yBACE,UACAC,cAAO,WACPC,aAAM,sCACQ,GACX,kBAAkB,CAAC,YAAY,EAAE,SAAS,YAAY,cACrD,mBAAmB;EACL;EACZ;EACA,GAAI,aAAa,EAAE,YAAY,GAAG,EAAE;EACpC,GAAI,SAAS,EAAE,QAAQ,GAAG,EAAE;EAC7B,CAAC,CAAC,iBAAiB,CACvB,CACF;;AAGH,MAAM,2BAA2B;AAI/B,OAAM,cAAc,IAAI;EACtB,IAAa,WAAW;AACtB,UAAO;;EAET,IAAa,WAAW;AACtB,UAAO;;;AAIX,QAAO,eAAe,QAAQ,WAAW,UAAU,EACjD,WAAW,IAAI,aAAa,EAC7B,CAAC"}