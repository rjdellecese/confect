{"version":3,"file":"QueryRunner.js","names":["Refs.getFunction","Refs.getConvexFunctionName"],"sources":["../../../src/server/QueryRunner.ts"],"sourcesContent":["import { type GenericQueryCtx } from \"convex/server\";\nimport type { ParseResult } from \"effect\";\nimport { Context, Effect, Layer, Schema } from \"effect\";\nimport * as Refs from \"../api/Refs\";\n\nconst make =\n  (runQuery: GenericQueryCtx<any>[\"runQuery\"]) =>\n  <Query extends Refs.Ref.AnyQuery>(\n    query: Query,\n    args: Refs.Ref.Args<Query>[\"Type\"],\n  ): Effect.Effect<Refs.Ref.Returns<Query>[\"Type\"], ParseResult.ParseError> =>\n    Effect.gen(function* () {\n      const function_ = Refs.getFunction(query);\n      const functionName = Refs.getConvexFunctionName(query);\n\n      const encodedArgs = yield* Schema.encode(function_.args)(args);\n      const encodedReturns = yield* Effect.promise(() =>\n        runQuery(functionName as any, encodedArgs),\n      );\n      return yield* Schema.decode(function_.returns)(encodedReturns);\n    });\n\nexport const QueryRunner = Context.GenericTag<ReturnType<typeof make>>(\n  \"@rjdellecese/confect/server/QueryRunner\",\n);\nexport type QueryRunner = typeof QueryRunner.Identifier;\n\nexport const layer = (runQuery: GenericQueryCtx<any>[\"runQuery\"]) =>\n  Layer.succeed(QueryRunner, make(runQuery));\n"],"mappings":";;;;;;;;;;AAKA,MAAM,QACH,cAEC,OACA,SAEA,OAAO,IAAI,aAAa;CACtB,MAAM,YAAYA,YAAiB,MAAM;CACzC,MAAM,eAAeC,sBAA2B,MAAM;CAEtD,MAAM,cAAc,OAAO,OAAO,OAAO,UAAU,KAAK,CAAC,KAAK;CAC9D,MAAM,iBAAiB,OAAO,OAAO,cACnC,SAAS,cAAqB,YAAY,CAC3C;AACD,QAAO,OAAO,OAAO,OAAO,UAAU,QAAQ,CAAC,eAAe;EAC9D;AAEN,MAAa,cAAc,QAAQ,WACjC,0CACD;AAGD,MAAa,SAAS,aACpB,MAAM,QAAQ,aAAa,KAAK,SAAS,CAAC"}