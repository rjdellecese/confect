{"version":3,"file":"OrderedQuery.js","names":["stream: OrderedQueryFunction<\"stream\">","Document.decode","first: OrderedQueryFunction<\"first\">","take: OrderedQueryFunction<\"take\">","collect: OrderedQueryFunction<\"collect\">","paginate: OrderedQueryFunction<\"paginate\">"],"sources":["../../../src/server/OrderedQuery.ts"],"sourcesContent":["import type {\n  OrderedQuery as ConvexOrderedQuery,\n  PaginationResult,\n} from \"convex/server\";\nimport { Chunk, Effect, identity, type Option, pipe, Stream } from \"effect\";\nimport * as Document from \"./Document\";\nimport type * as TableInfo from \"./TableInfo\";\n\nexport type OrderedQuery<\n  TableInfo_ extends TableInfo.TableInfo.AnyWithProps,\n  _TableName extends string,\n> = {\n  readonly first: () => Effect.Effect<\n    Option.Option<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n  readonly take: (\n    n: number,\n  ) => Effect.Effect<\n    ReadonlyArray<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n  readonly collect: () => Effect.Effect<\n    ReadonlyArray<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n  readonly stream: () => Stream.Stream<\n    TableInfo_[\"document\"],\n    Document.DocumentDecodeError\n  >;\n  readonly paginate: (options: {\n    cursor: string | null;\n    numItems: number;\n  }) => Effect.Effect<\n    PaginationResult<TableInfo_[\"document\"]>,\n    Document.DocumentDecodeError\n  >;\n};\n\nexport const make = <\n  TableInfo_ extends TableInfo.TableInfo.AnyWithProps,\n  TableName extends string,\n>(\n  query: ConvexOrderedQuery<TableInfo.TableInfo.TableInfo<TableInfo_>>,\n  tableName: TableName,\n  tableSchema: TableInfo.TableInfo.TableSchema<TableInfo_>,\n): OrderedQuery<TableInfo_, TableName> => {\n  type OrderedQueryFunction<\n    FunctionName extends keyof OrderedQuery<TableInfo_, TableName>,\n  > = OrderedQuery<TableInfo_, TableName>[FunctionName];\n\n  const streamEncoded = Stream.fromAsyncIterable(query, identity).pipe(\n    Stream.orDie,\n  );\n\n  const stream: OrderedQueryFunction<\"stream\"> = () =>\n    pipe(\n      streamEncoded,\n      Stream.mapEffect(Document.decode(tableName, tableSchema)),\n    );\n\n  const first: OrderedQueryFunction<\"first\"> = () =>\n    pipe(stream(), Stream.take(1), Stream.runHead);\n\n  const take: OrderedQueryFunction<\"take\"> = (n: number) =>\n    pipe(\n      stream(),\n      Stream.take(n),\n      Stream.runCollect,\n      Effect.map((chunk) => Chunk.toReadonlyArray(chunk)),\n    );\n\n  const collect: OrderedQueryFunction<\"collect\"> = () =>\n    pipe(stream(), Stream.runCollect, Effect.map(Chunk.toReadonlyArray));\n\n  const paginate: OrderedQueryFunction<\"paginate\"> = (options) =>\n    Effect.gen(function* () {\n      const paginationResult = yield* Effect.promise(() =>\n        query.paginate(options),\n      );\n\n      const parsedPage = yield* Effect.forEach(\n        paginationResult.page,\n        Document.decode(tableName, tableSchema),\n      );\n\n      return {\n        page: parsedPage,\n        isDone: paginationResult.isDone,\n        continueCursor: paginationResult.continueCursor,\n        /* v8 ignore start */\n        ...(paginationResult.splitCursor\n          ? { splitCursor: paginationResult.splitCursor }\n          : {}),\n        ...(paginationResult.pageStatus\n          ? { pageStatus: paginationResult.pageStatus }\n          : {}),\n        /* v8 ignore stop */\n      };\n    });\n\n  return {\n    first,\n    take,\n    collect,\n    paginate,\n    stream,\n  };\n};\n"],"mappings":";;;;;;AAuCA,MAAa,QAIX,OACA,WACA,gBACwC;CAKxC,MAAM,gBAAgB,OAAO,kBAAkB,OAAO,SAAS,CAAC,KAC9D,OAAO,MACR;CAED,MAAMA,eACJ,KACE,eACA,OAAO,UAAUC,OAAgB,WAAW,YAAY,CAAC,CAC1D;CAEH,MAAMC,cACJ,KAAK,QAAQ,EAAE,OAAO,KAAK,EAAE,EAAE,OAAO,QAAQ;CAEhD,MAAMC,QAAsC,MAC1C,KACE,QAAQ,EACR,OAAO,KAAK,EAAE,EACd,OAAO,YACP,OAAO,KAAK,UAAU,MAAM,gBAAgB,MAAM,CAAC,CACpD;CAEH,MAAMC,gBACJ,KAAK,QAAQ,EAAE,OAAO,YAAY,OAAO,IAAI,MAAM,gBAAgB,CAAC;CAEtE,MAAMC,YAA8C,YAClD,OAAO,IAAI,aAAa;EACtB,MAAM,mBAAmB,OAAO,OAAO,cACrC,MAAM,SAAS,QAAQ,CACxB;AAOD,SAAO;GACL,MANiB,OAAO,OAAO,QAC/B,iBAAiB,MACjBJ,OAAgB,WAAW,YAAY,CACxC;GAIC,QAAQ,iBAAiB;GACzB,gBAAgB,iBAAiB;GAEjC,GAAI,iBAAiB,cACjB,EAAE,aAAa,iBAAiB,aAAa,GAC7C,EAAE;GACN,GAAI,iBAAiB,aACjB,EAAE,YAAY,iBAAiB,YAAY,GAC3C,EAAE;GAEP;GACD;AAEJ,QAAO;EACL;EACA;EACA;EACA;EACA;EACD"}