{"version":3,"file":"GroupSpec.js","names":["Predicate","Record"],"sources":["../../../src/api/GroupSpec.ts"],"sourcesContent":["import { Predicate, Record } from \"effect\";\nimport { validateJsIdentifier } from \"../internal/utils\";\nimport type * as FunctionSpec from \"./FunctionSpec\";\n\nexport const TypeId = \"@rjdellecese/confect/api/GroupSpec\";\nexport type TypeId = typeof TypeId;\n\nexport const isGroupSpec = (u: unknown): u is GroupSpec.Any =>\n  Predicate.hasProperty(u, TypeId);\n\nexport interface GroupSpec<\n  Name extends string,\n  Functions extends FunctionSpec.FunctionSpec.AnyWithProps = never,\n  Groups extends GroupSpec.AnyWithProps = never,\n> {\n  readonly [TypeId]: TypeId;\n  readonly name: Name;\n  readonly functions: {\n    [FunctionName in FunctionSpec.FunctionSpec.Name<Functions>]: FunctionSpec.FunctionSpec.WithName<\n      Functions,\n      FunctionName\n    >;\n  };\n  readonly groups: {\n    [GroupName in GroupSpec.Name<Groups>]: GroupSpec.WithName<\n      Groups,\n      GroupName\n    >;\n  };\n\n  // TODO: `addQuery`, `addMutation`, `addAction`, etc.\n  addFunction<Function extends FunctionSpec.FunctionSpec.AnyWithProps>(\n    function_: Function,\n  ): GroupSpec<Name, Functions | Function, Groups>;\n\n  addGroup<Group extends GroupSpec.AnyWithProps>(\n    group: Group,\n  ): GroupSpec<Name, Functions, Groups | Group>;\n}\n\nexport declare namespace GroupSpec {\n  export interface Any {\n    readonly [TypeId]: TypeId;\n  }\n\n  // TODO: Can we extend the `GroupSpec` interface and remove these custom fields?\n  export interface AnyWithProps extends Any {\n    readonly name: string;\n    readonly functions: {\n      [key: string]: FunctionSpec.FunctionSpec.AnyWithProps;\n    };\n    readonly groups: {\n      [key: string]: AnyWithProps;\n    };\n    addFunction<Function extends FunctionSpec.FunctionSpec.AnyWithProps>(\n      function_: Function,\n    ): AnyWithProps;\n    addGroup<Group extends AnyWithProps>(group: Group): AnyWithProps;\n  }\n\n  export type Name<Group extends AnyWithProps> = Group[\"name\"];\n\n  export type Functions<Group extends AnyWithProps> =\n    Group[\"functions\"][keyof Group[\"functions\"]];\n\n  export type Groups<Group extends AnyWithProps> =\n    Group[\"groups\"][keyof Group[\"groups\"]];\n\n  export type GroupNames<Group extends AnyWithProps> = [Groups<Group>] extends [\n    never,\n  ]\n    ? never\n    : Name<Groups<Group>>;\n\n  export type WithName<\n    Group extends AnyWithProps,\n    Name_ extends Name<Group>,\n  > = Extract<Group, { readonly name: Name_ }>;\n}\n\nexport declare namespace Path {\n  // Recursively generates paths for a group and its nested groups.\n  // For a group with no subgroups, returns just the group name.\n  // For a group with subgroups, returns the group name plus all possible paths\n  // through its direct subgroups. Properly distributes over union types to prevent\n  // cross-contamination of paths from different groups.\n  export type All<\n    Group extends GroupSpec.AnyWithProps,\n    Depth extends 1[] = [],\n  > = Depth[\"length\"] extends 15\n    ? string\n    : Group extends any\n      ? [GroupSpec.Groups<Group>] extends [never]\n        ? GroupSpec.Name<Group>\n        :\n            | GroupSpec.Name<Group>\n            | AllHelper<Group, GroupSpec.Groups<Group>, Depth>\n      : never;\n\n  type AllHelper<\n    Parent extends GroupSpec.AnyWithProps,\n    Groups extends GroupSpec.AnyWithProps,\n    Depth extends 1[] = [],\n  > = Groups extends GroupSpec.AnyWithProps\n    ? `${GroupSpec.Name<Parent>}.${All<Groups, [...Depth, 1]>}`\n    : never;\n\n  /**\n   * Recursively extracts the group at the given dot-separated path.\n   * Path must match the format defined in `Path` above, e.g. \"group\" or \"group.subgroup\".\n   *\n   * Example:\n   *   type G = WithPath<RootGroup, \"group.subgroup\">;\n   */\n  export type GroupAt<\n    Group,\n    Path extends string,\n  > = Group extends GroupSpec.AnyWithProps\n    ? Path extends `${infer Head}.${infer Tail}`\n      ? Group extends { readonly name: Head }\n        ? Group extends {\n            readonly groups: Record.ReadonlyRecord<string, infer SubGroup>;\n          }\n          ? GroupAt<SubGroup, Tail>\n          : never\n        : never\n      : GroupSpec.WithName<Group, Path>\n    : never;\n\n  export type SubGroupsAt<\n    Group extends GroupSpec.AnyWithProps,\n    GroupPath extends string,\n  > =\n    GroupSpec.Groups<GroupAt<Group, GroupPath>> extends infer SubGroups\n      ? SubGroups extends GroupSpec.AnyWithProps\n        ? `${GroupPath}.${GroupSpec.Name<SubGroups>}`\n        : never\n      : never;\n}\n\nconst Proto = {\n  [TypeId]: TypeId,\n\n  addFunction<Function extends FunctionSpec.FunctionSpec.AnyWithProps>(\n    this: GroupSpec.Any,\n    function_: Function,\n  ) {\n    const this_ = this as GroupSpec.AnyWithProps;\n\n    return makeProto({\n      name: this_.name,\n      functions: Record.set(this_.functions, function_.name, function_),\n      groups: this_.groups,\n    });\n  },\n\n  addGroup<Group extends GroupSpec.Any>(this: GroupSpec.Any, group: Group) {\n    const this_ = this as GroupSpec.AnyWithProps;\n    const group_ = group as unknown as GroupSpec.AnyWithProps;\n\n    return makeProto({\n      name: this_.name,\n      functions: this_.functions,\n      groups: Record.set(this_.groups, group_.name, group_),\n    });\n  },\n};\n\nconst makeProto = <\n  Name extends string,\n  Functions extends FunctionSpec.FunctionSpec.AnyWithProps,\n  Groups extends GroupSpec.AnyWithProps,\n>({\n  name,\n  functions,\n  groups,\n}: {\n  name: Name;\n  functions: Record.ReadonlyRecord<string, Functions>;\n  groups: Record.ReadonlyRecord<string, Groups>;\n}): GroupSpec<Name, Functions, Groups> =>\n  Object.assign(Object.create(Proto), {\n    name,\n    functions,\n    groups,\n  });\n\nexport const make = <const Name extends string>(\n  name: Name,\n): GroupSpec<Name> => {\n  validateJsIdentifier(name);\n\n  return makeProto({\n    name,\n    functions: Record.empty(),\n    groups: Record.empty(),\n  });\n};\n"],"mappings":";;;;;;;;;;AAIA,MAAa,SAAS;AAGtB,MAAa,eAAe,MAC1BA,iBAAU,YAAY,GAAG,OAAO;AAoIlC,MAAM,QAAQ;EACX,SAAS;CAEV,YAEE,WACA;EACA,MAAM,QAAQ;AAEd,SAAO,UAAU;GACf,MAAM,MAAM;GACZ,WAAWC,cAAO,IAAI,MAAM,WAAW,UAAU,MAAM,UAAU;GACjE,QAAQ,MAAM;GACf,CAAC;;CAGJ,SAA2D,OAAc;EACvE,MAAM,QAAQ;EACd,MAAM,SAAS;AAEf,SAAO,UAAU;GACf,MAAM,MAAM;GACZ,WAAW,MAAM;GACjB,QAAQA,cAAO,IAAI,MAAM,QAAQ,OAAO,MAAM,OAAO;GACtD,CAAC;;CAEL;AAED,MAAM,aAIJ,EACA,MACA,WACA,aAMA,OAAO,OAAO,OAAO,OAAO,MAAM,EAAE;CAClC;CACA;CACA;CACD,CAAC;AAEJ,MAAa,QACX,SACoB;AACpB,6CAAqB,KAAK;AAE1B,QAAO,UAAU;EACf;EACA,WAAWA,cAAO,OAAO;EACzB,QAAQA,cAAO,OAAO;EACvB,CAAC"}