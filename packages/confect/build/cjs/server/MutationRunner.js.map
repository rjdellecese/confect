{"version":3,"file":"MutationRunner.js","names":["Effect","Schema","Context","Layer"],"sources":["../../../src/server/MutationRunner.ts"],"sourcesContent":["import { type GenericMutationCtx } from \"convex/server\";\nimport { Context, Effect, Layer, Schema } from \"effect\";\nimport * as Refs from \"../api/Refs\";\n\nconst makeMutationRunner =\n  (runMutation: GenericMutationCtx<any>[\"runMutation\"]) =>\n  <Mutation extends Refs.Ref.AnyMutation>(\n    mutation: Mutation,\n    args: Refs.Ref.Args<Mutation>[\"Type\"],\n  ) =>\n    Effect.gen(function* () {\n      const function_ = Refs.getFunction(mutation);\n      const functionName = Refs.getConvexFunctionName(mutation);\n\n      const encodedArgs = yield* Schema.encode(function_.args)(args);\n      const encodedReturns = yield* Effect.promise(() =>\n        runMutation(functionName as any, encodedArgs),\n      );\n      return yield* Schema.decode(function_.returns)(encodedReturns);\n    });\n\nexport const MutationRunner = Context.GenericTag<\n  ReturnType<typeof makeMutationRunner>\n>(\"@rjdellecese/confect/server/MutationRunner\");\nexport type MutationRunner = typeof MutationRunner.Identifier;\n\nexport const layer = (runMutation: GenericMutationCtx<any>[\"runMutation\"]) =>\n  Layer.succeed(MutationRunner, makeMutationRunner(runMutation));\n\nexport class MutationRollback extends Schema.TaggedError<MutationRollback>(\n  \"MutationRollback\",\n)(\"MutationRollback\", {\n  mutationName: Schema.String,\n  error: Schema.Unknown,\n}) {\n  /* v8 ignore start */\n  override get message(): string {\n    return `Mutation ${this.mutationName} failed and was rolled back.\\n\\n${this.error}`;\n  }\n  /* v8 ignore stop */\n}\n"],"mappings":";;;;;;;;;;;AAIA,MAAM,sBACH,iBAEC,UACA,SAEAA,cAAO,IAAI,aAAa;CACtB,MAAM,yCAA6B,SAAS;CAC5C,MAAM,sDAA0C,SAAS;CAEzD,MAAM,cAAc,OAAOC,cAAO,OAAO,UAAU,KAAK,CAAC,KAAK;CAC9D,MAAM,iBAAiB,OAAOD,cAAO,cACnC,YAAY,cAAqB,YAAY,CAC9C;AACD,QAAO,OAAOC,cAAO,OAAO,UAAU,QAAQ,CAAC,eAAe;EAC9D;AAEN,MAAa,iBAAiBC,eAAQ,WAEpC,6CAA6C;AAG/C,MAAa,SAAS,gBACpBC,aAAM,QAAQ,gBAAgB,mBAAmB,YAAY,CAAC;AAEhE,IAAa,mBAAb,cAAsCF,cAAO,YAC3C,mBACD,CAAC,oBAAoB;CACpB,cAAcA,cAAO;CACrB,OAAOA,cAAO;CACf,CAAC,CAAC;;CAED,IAAa,UAAkB;AAC7B,SAAO,YAAY,KAAK,aAAa,kCAAkC,KAAK"}